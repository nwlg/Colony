/* Agrega es una federación de repositorios de objetos digitales educativos formada por todas las Comunidades Autónomas propiedad de Red.es. Este código ha sido desarrollado por la Entidad Pública Empresarial red.es adscrita al Ministerio de Industria,Turismo y Comercio a través de la Secretaría de Estado de Telecomunicaciones y para la Sociedad de la Información, dentro del Programa Internet en el Aula, que se encuadra dentro de las actuaciones previstas en el Plan Avanza (Plan 2006-2010 para el desarrollo de la Sociedad de la Información y de Convergencia con Europa y entre Comunidades Autónomas y Ciudades Autónomas) y ha sido cofinanciado con fondos FEDER del Programa Operativo FEDER 2000-2006 “Sociedad de la Información”

This program is free software: you can redistribute it and/or modify it under the terms of the European Union Public Licence (EUPL v.1.0).  This program is distributed in the hope that it will be useful,  but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the European Union Public Licence (EUPL v.1.0). You should have received a copy of the EUPL licence along with this program.  If not, see http://ec.europa.eu/idabc/en/document/7330.
*/
// license-header java merge-point                                                                                                                                                                                                                                                                                                                                                          
/**                                                                                                                                                                                                                                                                                                                                                                                         
 * This is only generated once! It will never be overwritten.                                                                                                                                                                                                                                                                                                                               
 * You can (and have to!) safely modify it by hand.                                                                                                                                                                                                                                                                                                                                         
 */                                                                                                                                                                                                                                                                                                                                                                                         
package es.pode.agregador.negocio.agregador.servicio;                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
import java.awt.image.BufferedImage;                                                                                                                                                                                                                                                                                                                                                        
import java.io.File;                                                                                                                                                                                                                                                                                                                                                                        
import java.io.FileWriter;                                                                                                                                                                                                                                                                                                                                                                  
import java.io.IOException;                                                                                                                                                                                                                                                                                                                                                                 
import java.io.InputStream;                                                                                                                                                                                                                                                                                                                                                                 
import java.io.InputStreamReader;
import java.io.Writer;
import java.net.URL;
import java.rmi.RemoteException;                                                                                                                                                                                                                                                                                                                                                            
import java.text.MessageFormat;                                                                                                                                                                                                                                                                                                                                                             
import java.text.SimpleDateFormat;                                                                                                                                                                                                                                                                                                                                                          
import java.util.ArrayList;                                                                                                                                                                                                                                                                                                                                                                 
import java.util.Arrays;                                                                                                                                                                                                                                                                                                                                                                    
import java.util.Calendar;                                                                                                                                                                                                                                                                                                                                                                  
import java.util.Collections;                                                                                                                                                                                                                                                                                                                                                               
import java.util.Date;                                                                                                                                                                                                                                                                                                                                                                      
import java.util.HashMap;
import java.util.List;                                                                                                                                                                                                                                                                                                                                                                      
import java.util.Locale;                                                                                                                                                                                                                                                                                                                                                                    
import java.util.ResourceBundle;                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
import javax.activation.DataHandler;                                                                                                                                                                                                                                                                                                                                                        
import javax.activation.FileDataSource;                                                                                                                                                                                                                                                                                                                                                     
import javax.imageio.ImageIO;                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                            
import org.apache.log4j.Logger;                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                            
import com.sun.syndication.feed.synd.SyndContent;                                                                                                                                                                                                                                                                                                                                           
import com.sun.syndication.feed.synd.SyndContentImpl;                                                                                                                                                                                                                                                                                                                                       
import com.sun.syndication.feed.synd.SyndEntry;                                                                                                                                                                                                                                                                                                                                             
import com.sun.syndication.feed.synd.SyndEntryImpl;                                                                                                                                                                                                                                                                                                                                         
import com.sun.syndication.feed.synd.SyndFeed;                                                                                                                                                                                                                                                                                                                                              
import com.sun.syndication.feed.synd.SyndFeedImpl;                                                                                                                                                                                                                                                                                                                                          
import com.sun.syndication.feed.synd.SyndImageImpl;                                                                                                                                                                                                                                                                                                                                         
import com.sun.syndication.io.SyndFeedInput;                                                                                                                                                                                                                                                                                                                                                
import com.sun.syndication.io.SyndFeedOutput;                                                                                                                                                                                                                                                                                                                                               
import com.sun.syndication.io.XmlReader;                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                            
import es.agrega.soporte.agregaProperties.AgregaProperties;
import es.agrega.soporte.agregaProperties.AgregaPropertiesImpl;                                                                                                                                                                                                                                                                                                                             
import es.agrega.soporte.serverProperties.DependentServerProperties;                                                                                                                                                                                                                                                                                                                        
import es.pode.agregador.comun.FechaComparator;                                                                                                                                                                                                                                                                                                                                             
import es.pode.agregador.comun.NumVecesComparator;                                                                                                                                                                                                                                                                                                                                          
import es.pode.auditoria.negocio.servicios.InformeMasVO;                                                                                                                                                                                                                                                                                                                                    
import es.pode.auditoria.negocio.servicios.ParametrosInformeVO;                                                                                                                                                                                                                                                                                                                             
import es.pode.auditoria.negocio.servicios.SrvAuditoriaServicio;                                                                                                                                                                                                                                                                                                                            
import es.pode.buscar.negocio.administrar.servicio.NodoVO;                                                                                                                                                                                                                                                                                                                                  
import es.pode.buscar.negocio.buscar.servicios.MetadatoBasicoVO;                                                                                                                                                                                                                                                                                                                            
import es.pode.buscar.negocio.buscar.servicios.ParametroMetadatoVO;                                                                                                                                                                                                                                                                                                                         
import es.pode.buscar.negocio.buscar.servicios.ParametrosBusquedaAvanzadaVO;                                                                                                                                                                                                                                                                                                                
import es.pode.buscar.negocio.buscar.servicios.ResultadoBusquedaVO;                                                                                                                                                                                                                                                                                                                         
import es.pode.buscar.negocio.buscar.servicios.ValoresBusquedaVO;                                                                                                                                                                                                                                                                                                                           
import es.pode.contenidos.negocio.noticias.servicio.NoticiaTraducidaVO;                                                                                                                                                                                                                                                                                                                     
import es.pode.contenidos.negocio.noticias.servicio.SrvNoticiasService;                                                                                                                                                                                                                                                                                                                     
import es.pode.fuentestaxonomicas.negocio.servicio.TaxonVO;                                                                                                                                                                                                                                                                                                                                 
import es.pode.fuentestaxonomicas.negocio.servicio.TerminoYPadreVO;                                                                                                                                                                                                                                                                                                                         
import es.pode.indexador.negocio.servicios.busqueda.SrvBuscadorService;                                                                                                                                                                                                                                                                                                                     
import es.pode.publicacion.negocio.servicios.OdePublicadoVO;                                                                                                                                                                                                                                                                                                                                
import es.pode.soporte.buscador.TraduccionesBuscador;                                                                                                                                                                                                                                                                                                                                       
import es.pode.soporte.buscar.BuscarController;                                                                                                                                                                                                                                                                                                                                             
import es.pode.soporte.i18n.I18n;                                                                                                                                                                                                                                                                                                                                                           
import es.pode.soporte.seguridad.ldap.LdapUserDetailsUtils;
/**                                                                                                                                                                                                                                                                                                                                                                                         
 * @see es.pode.agregador.negocio.agregador.servicio.SrvAgregadorRssService                                                                                                                                                                                                                                                                                                                 
 */                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
public class SrvAgregadorRssServiceImpl                                                                                                                                                                                                                                                                                                                                                     
    extends es.pode.agregador.negocio.agregador.servicio.SrvAgregadorRssServiceBase                                                                                                                                                                                                                                                                                                         
{                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
	private static Logger logger = Logger.getLogger(SrvAgregadorRssServiceImpl.class);                                                                                                                                                                                                                                                                                                     
	private java.util.Properties pAgregadorRSSProperties = null;                                                                                                                                                                                                                                                                                                                        
	private static String feedHost = LdapUserDetailsUtils.getHost()+LdapUserDetailsUtils.getSubdominio();                                                                                                                                                                                                                                                                                            
	private static String feedPath = "uploads/rss/";                                                                                                                                                                                                                                                                                                                                    
	private static String feedPathResultadosBusqueda = "uploads/rss/temp/";	                                                                                                                                                                                                                                                                                                            
	private static String http = "http://";                                                                                                                                                                                                                                                                                                                                             
	private static String rssPath = "";                                                                                                                                                                                                                                                                                                                                                 
	private static String fileName = "";                                                                                                                                                                                                                                                                                                                                                
	private static String IMAGEN_AMPLIADA= "_captured.jpg";                                                                                                                                                                                                                                                                                                                             
	private static String IMAGEN_MINIMIZADA= "png";                                                                                                                                                                                                                                                                                                                                     
	private static String rss = AgregaPropertiesImpl.getInstance().getProperty("rss");                                                                                                                                                                                                                                                                                                  
	private SyndFeed feed = new SyndFeedImpl();                                                                                                                                                                                                                                                                                                                                         
	private SrvBuscadorService srvBuscadorService;
	private static HashMap mapaIdiomas = new HashMap(); // mapa que alberga los bunlde para cada idioma.
	private final static String PUNTO = "\\.";   
	public static final String UNIVERSAL = "universal";
	public static final String IDENTIFICADOR_NODO = "server.id";
	private final static String NIV_EDU_SEPARATOR = "/";


	/**                                                                                                                                                                                                                                                                                                                                                                                 
     * @see es.pode.agregador.negocio.agregador.servicio.SrvAgregadorRssService#crearXML()                                                                                                                                                                                                                                                                                                  
     */                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                            
	protected void handleCrearXML()                                                                                                                                                                                                                                                                                                                                                     
        throws java.lang.Exception                                                                                                                                                                                                                                                                                                                                                          
    {                                                                                                                                                                                                                                                                                                                                                                                       
        try {                                                                                                                                                                                                                                                                                                                                                                               
			log("SrvAgregadorRssServiceImpl - comienza a generar los feeds...");                                                                                                                                                                                                                                                                                          
            //Datos comunes para todos los xml                                                                                                                                                                                                                                                                                                                                              
            //Creamos el feed                                                                                                                                                                                                                                                                                                                                                               
        	feed.setEncoding("ISO-8859-1");
        	feed.setAuthor("Agrega");
	        feed.setPublishedDate(new Date());
            srvBuscadorService = this.getSrvBuscadorService();                                                                                                                                                                                                                                                                                                                              
    		Integer numResultados = new Integer(getPropertyValue("numResultados"));                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                            
        	try{                                                                                                                                                                                                                                                                                                                                                                        
	            //SERVICIO AUDITORIA                                                                                                                                                                                                                                                                                                                                                    
        		//parámetros necesarios para hacer la llamada al servicio de auditoría                                                                                                                                                                                                                                                                                              
                SrvAuditoriaServicio srvAuditoriaServicio = this.getSrvAuditoriaServicio();                                                                                                                                                                                                                                                                                                 
                ParametrosInformeVO parametrosInformeVO = new ParametrosInformeVO();                                                                                                                                                                                                                                                                                                        
	        	parametrosInformeVO.setRango(numResultados);                                                                                                                                                                                                                                                                                                                        
	        	parametrosInformeVO.setFechaHasta(Calendar.getInstance());                                                                                                                                                                                                                                                                                                          
	        	Calendar calendar_anio = Calendar.getInstance();                                                                                                                                                                                                                                                                                                                    
        		calendar_anio.add(Calendar.DATE, -365);                                                                                                                                                                                                                                                                                                                             
	        	Calendar calendar_semana = Calendar.getInstance();                                                                                                                                                                                                                                                                                                                  
	        	calendar_semana.add(Calendar.DATE, -7);                                                                                                                                                                                                                                                                                                                             
	        	Calendar calendar_mes = Calendar.getInstance();                                                                                                                                                                                                                                                                                                                     
	        	calendar_mes.add(Calendar.DATE, -30);                                                                                                                                                                                                                                                                                                                               
	        	                                                                                                                                                                                                                                                                                                                                                                    
	        	String idioma = I18n.getInstance().obtenerIdiomaDefectoPlataforma();                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//NOTICIAS                                                                                                                                                                                                                                                                                                                                                  
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed noticias...");                                                                                                                                                                                                                                                                             
	    			NoticiaTraducidaVO[] noticias = this.obtenerNoticias();                                                                                                                                                                                                                                                                                                     
	    			crearXMLnoticias(noticias,                                                                                                                                                                                                                                                                                                                                  
		            		"noticias.title", getPropertyValue("noticias.url"), traduceEtiqueta("noticias.descripcion",idioma),                                                                                                                                                                                                                                              
		            		getPropertyValue("noticias_rss.fileName"), getPropertyValue("noticias_atom.fileName"),idioma);                                                                                                                                                                                                                                                             
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de noticias: " , e);                                                                                                                                                                                                                                                                  
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//SERVICIO AUDITAPUBLICACION                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed ultimos odes publicados...");                                                                                                                                                                                                                                                              
		        	OdePublicadoVO[] ultimosOdes = this.getSrvAuditaPublicacionService().obtenerUltimosOdesPublicados(numResultados.intValue());                                                                                                                                                                                                                                
		        	crearXMLauditoria(ultimosOdes,                                                                                                                                                                                                                                                                                                                              
		            		"ultimosOdes.title", getPropertyValue("ultimosOdes.url"), traduceEtiqueta("ultimosOdes.descripcion",idioma),
		            		getPropertyValue("ultimosOdes_rss.fileName"), getPropertyValue("ultimosOdes_atom.fileName"),idioma);                                                                                                                                                                                                                                                       
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de los últimos ODEs publicados: " + e);                                                                                                                                                                                                                                               
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//SERVICIO AUDITAPUBLICACION                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed ultimos odes federados publicados...");                                                                                                                                                                                                                                                    
		        	crearXMLauditoriaFederada(getPropertyValue("ultimosOdes_rss.fileName"), "ultimosOdes_Federado.title",                                                                                                                                                                                                                                                       
        					getPropertyValue("ultimosOdes_Federado.url"), traduceEtiqueta("ultimosOdes_Federado.descripcion",idioma),
        					getPropertyValue("ultimosOdes_Federado_rss.fileName"), getPropertyValue("ultimosOdes_Federado_atom.fileName"),idioma);                                                                                                                                                                                                                             
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de los últimos ODEs federados publicados: " + e);                                                                                                                                                                                                                                     
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		InformeMasVO[] masDescargados = null;                                                                                                                                                                                                                                                                                                                               
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS DESCARGADOS                                                                                                                                                                                                                                                                                                                                           
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas descargados AÑO...");                                                                                                                                                                                                                                                             
	    			parametrosInformeVO.setFechaDesde(calendar_anio);                                                                                                                                                                                                                                                                                                           
		        	masDescargados = srvAuditoriaServicio.informeMasDescargados(parametrosInformeVO);                                                                                                                                                                                                                                                                           
		    		crearXMLauditoria(masDescargados,                                                                                                                                                                                                                                                                                                                           
		            		"masDescargados_anio.title", getPropertyValue("masDescargados.url"), traduceEtiqueta("masDescargados_anio.descripcion",idioma),
		            		getPropertyValue("masDescargados_anio_rss.fileName"), getPropertyValue("masDescargados_anio_atom.fileName"),idioma);                                                                                                                                                                                                                                       
		    	} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más descargados AÑO: ", e);                                                                                                                                                                                                                                                   
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS DESCARGADOS                                                                                                                                                                                                                                                                                                                                           
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas descargados AÑO...");                                                                                                                                                                                                                                                   
	    			crearXMLauditoriaFederada(getPropertyValue("masDescargados_anio_rss.fileName"), "masDescargados_Federado_anio.title",                                                                                                                                                                                                                                       
		        			getPropertyValue("masDescargados_Federado.url"), traduceEtiqueta("masDescargados_Federado_anio.descripcion",idioma),
		        			getPropertyValue("masDescargados_Federado_anio_rss.fileName"), getPropertyValue("masDescargados_Federado_anio_atom.fileName"),idioma);                                                                                                                                                                                                             
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más descargados AÑO: ", e);                                                                                                                                                                                                                                         
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas descargados SEMANA...");                                                                                                                                                                                                                                                          
		        	parametrosInformeVO.setFechaDesde(calendar_semana);                                                                                                                                                                                                                                                                                                         
		        	masDescargados = srvAuditoriaServicio.informeMasDescargados(parametrosInformeVO);                                                                                                                                                                                                                                                                           
		    		crearXMLauditoria(masDescargados,                                                                                                                                                                                                                                                                                                                           
		            		"masDescargados_semana.title", getPropertyValue("masDescargados.url"), traduceEtiqueta("masDescargados_semana.descripcion",idioma),
		            		getPropertyValue("masDescargados_semana_rss.fileName"), getPropertyValue("masDescargados_semana_atom.fileName"),idioma);                                                                                                                                                                                                                                   
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más descargados SEMANA: ", e);                                                                                                                                                                                                                                                
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
				log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas descargados SEMANA...");                                                                                                                                                                                                                                                
		        	crearXMLauditoriaFederada(getPropertyValue("masDescargados_semana_rss.fileName"), "masDescargados_Federado_semana.title",                                                                                                                                                                                                                                   
							getPropertyValue("masDescargados_Federado.url"), traduceEtiqueta("masDescargados_Federado_semana.descripcion",idioma),
							getPropertyValue("masDescargados_Federado_semana_rss.fileName"), getPropertyValue("masDescargados_Federado_semana_atom.fileName"),idioma);                                                                                                                                                                                                 
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más descargados SEMANA: ", e);                                                                                                                                                                                                                                      
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas descargados MES...");                                                                                                                                                                                                                                                             
		        	parametrosInformeVO.setFechaDesde(calendar_mes);                                                                                                                                                                                                                                                                                                            
		        	masDescargados = srvAuditoriaServicio.informeMasDescargados(parametrosInformeVO);                                                                                                                                                                                                                                                                           
		    		crearXMLauditoria(masDescargados,                                                                                                                                                                                                                                                                                                                           
		            		"masDescargados_mes.title", getPropertyValue("masDescargados.url"), traduceEtiqueta("masDescargados_mes.descripcion",idioma),
		            		getPropertyValue("masDescargados_mes_rss.fileName"), getPropertyValue("masDescargados_mes_atom.fileName"),idioma);                                                                                                                                                                                                                                         
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más descargados MES: ", e);                                                                                                                                                                                                                                                   
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas descargados MES...");                                                                                                                                                                                                                                                   
	    			crearXMLauditoriaFederada(getPropertyValue("masDescargados_mes_rss.fileName"), "masDescargados_Federado_mes.title",                                                                                                                                                                                                                                         
							getPropertyValue("masDescargados_Federado.url"), traduceEtiqueta("masDescargados_Federado_mes.descripcion",idioma),
							getPropertyValue("masDescargados_Federado_mes_rss.fileName"), getPropertyValue("masDescargados_Federado_mes_atom.fileName"),idioma);                                                                                                                                                                                                       
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más descargados MES: ", e);                                                                                                                                                                                                                                         
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		InformeMasVO[] masMostrados = null;                                                                                                                                                                                                                                                                                                                                 
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS VISTOS                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas vistos AÑO...");                                                                                                                                                                                                                                                                  
		        	parametrosInformeVO.setFechaDesde(calendar_anio);                                                                                                                                                                                                                                                                                                           
		        	masMostrados = srvAuditoriaServicio.informeMasMostrado(parametrosInformeVO);                                                                                                                                                                                                                                                                                
		        	crearXMLauditoria(masMostrados,                                                                                                                                                                                                                                                                                                                             
		            		"masMostrados_anio.title", getPropertyValue("masMostrados.url"), traduceEtiqueta("masMostrados_anio.descripcion",idioma),
		            		getPropertyValue("masMostrados_anio_rss.fileName"), getPropertyValue("masMostrados_anio_atom.fileName"),idioma);                                                                                                                                                                                                                                           
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más vistos AÑO: ", e);                                                                                                                                                                                                                                                        
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS VISTOS                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas vistos AÑO...");                                                                                                                                                                                                                                                        
	    			crearXMLauditoriaFederada(getPropertyValue("masMostrados_anio_rss.fileName"), "masMostrados_Federado_anio.title",                                                                                                                                                                                                                                           
							getPropertyValue("masMostrados_Federado.url"), traduceEtiqueta("masMostrados_Federado_anio.descripcion",idioma),
							getPropertyValue("masMostrados_Federado_anio_rss.fileName"), getPropertyValue("masMostrados_Federado_anio_atom.fileName"),idioma);                                                                                                                                                                                                         
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más vistos AÑO: ", e);                                                                                                                                                                                                                                              
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas vistos SEMANA...");                                                                                                                                                                                                                                                               
		        	parametrosInformeVO.setFechaDesde(calendar_semana);                                                                                                                                                                                                                                                                                                         
		        	masMostrados = srvAuditoriaServicio.informeMasMostrado(parametrosInformeVO);                                                                                                                                                                                                                                                                                
		        	crearXMLauditoria(masMostrados,                                                                                                                                                                                                                                                                                                                             
		            		"masMostrados_semana.title", getPropertyValue("masMostrados.url"), traduceEtiqueta("masMostrados_semana.descripcion",idioma),                                                                                                                                                                                                                    
		            		getPropertyValue("masMostrados_semana_rss.fileName"), getPropertyValue("masMostrados_semana_atom.fileName"),idioma);                                                                                                                                                                                                                                       
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más vistos SEMANA: ", e);                                                                                                                                                                                                                                                     
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas vistos SEMANA...");                                                                                                                                                                                                                                                     
	    			crearXMLauditoriaFederada(getPropertyValue("masMostrados_semana_rss.fileName"), "masMostrados_Federado_semana.title",                                                                                                                                                                                                                                       
							getPropertyValue("masMostrados_Federado.url"), traduceEtiqueta("masMostrados_Federado_semana.descripcion",idioma),
							getPropertyValue("masMostrados_Federado_semana_rss.fileName"), getPropertyValue("masMostrados_Federado_semana_atom.fileName"),idioma);                                                                                                                                                                                                     
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más vistos SEMANA: ", e);                                                                                                                                                                                                                                           
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas vistos MES...");                                                                                                                                                                                                                                                                  
		        	parametrosInformeVO.setFechaDesde(calendar_mes);                                                                                                                                                                                                                                                                                                            
		        	masMostrados = srvAuditoriaServicio.informeMasMostrado(parametrosInformeVO);                                                                                                                                                                                                                                                                                
		        	crearXMLauditoria(masMostrados,                                                                                                                                                                                                                                                                                                                             
		            		"masMostrados_mes.title", getPropertyValue("masMostrados.url"), traduceEtiqueta("masMostrados_mes.descripcion",idioma),
		            		getPropertyValue("masMostrados_mes_rss.fileName"), getPropertyValue("masMostrados_mes_atom.fileName"),idioma);                                                                                                                                                                                                                                             
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más vistos MES: ", e);                                                                                                                                                                                                                                                        
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas vistos MES...");                                                                                                                                                                                                                                                        
	    			crearXMLauditoriaFederada(getPropertyValue("masMostrados_mes_rss.fileName"), "masMostrados_Federado_mes.title",                                                                                                                                                                                                                                             
							getPropertyValue("masMostrados_Federado.url"), traduceEtiqueta("masMostrados_Federado_mes.descripcion",idioma),
							getPropertyValue("masMostrados_Federado_mes_rss.fileName"), getPropertyValue("masMostrados_Federado_mes_atom.fileName"),idioma);                                                                                                                                                                                                           
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más vistos MES: ", e);                                                                                                                                                                                                                                              
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		InformeMasVO[] masPrevisualizados = null;                                                                                                                                                                                                                                                                                                                           
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS PREVISUALIZADOS                                                                                                                                                                                                                                                                                                                                       
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas previsualizados AÑO...");                                                                                                                                                                                                                                                         
		        	parametrosInformeVO.setFechaDesde(calendar_anio);                                                                                                                                                                                                                                                                                                           
		        	masPrevisualizados = srvAuditoriaServicio.informeMasPrevisualizados(parametrosInformeVO);                                                                                                                                                                                                                                                                   
		        	crearXMLauditoria(masPrevisualizados,                                                                                                                                                                                                                                                                                                                       
		            		"masPrevisualizados_anio.title", getPropertyValue("masPrevisualizados.url"), traduceEtiqueta("masPrevisualizados_anio.descripcion",idioma),
		            		getPropertyValue("masPrevisualizados_anio_rss.fileName"), getPropertyValue("masPrevisualizados_anio_atom.fileName"),idioma);                                                                                                                                                                                                                               
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más previsualizados AÑO: ", e);                                                                                                                                                                                                                                               
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
		        	//MAS PREVISUALIZADOS                                                                                                                                                                                                                                                                                                                                       
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas previsualizados...AÑO");                                                                                                                                                                                                                                                
	    			crearXMLauditoriaFederada(getPropertyValue("masPrevisualizados_anio_rss.fileName"), "masPrevisualizados_Federado_anio.title",                                                                                                                                                                                                                               
							getPropertyValue("masPrevisualizados_Federado.url"), traduceEtiqueta("masPrevisualizados_Federado_anio.descripcion",idioma),
							getPropertyValue("masPrevisualizados_Federado_anio_rss.fileName"), getPropertyValue("masPrevisualizados_Federado_anio_atom.fileName"),idioma);                                                                                                                                                                                             
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más previsualizados AÑO: ", e);                                                                                                                                                                                                                                     
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas previsualizados SEMANA...");                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                            
		        	masPrevisualizados = srvAuditoriaServicio.informeMasPrevisualizados(parametrosInformeVO);                                                                                                                                                                                                                                                                   
		        	crearXMLauditoria(masPrevisualizados,                                                                                                                                                                                                                                                                                                                       
		            		"masPrevisualizados_semana.title", getPropertyValue("masPrevisualizados.url"), traduceEtiqueta("masPrevisualizados_semana.descripcion",idioma),
		            		getPropertyValue("masPrevisualizados_semana_rss.fileName"), getPropertyValue("masPrevisualizados_semana_atom.fileName"),idioma);                                                                                                                                                                                                                           
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más previsualizados SEMANA: ", e);                                                                                                                                                                                                                                            
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas previsualizados SEMANA...");                                                                                                                                                                                                                                            
	    			crearXMLauditoriaFederada(getPropertyValue("masPrevisualizados_semana_rss.fileName"), "masPrevisualizados_Federado_semana.title",                                                                                                                                                                                                                           
							getPropertyValue("masPrevisualizados_Federado.url"), traduceEtiqueta("masPrevisualizados_Federado_semana.descripcion",idioma),                                                                                                                                                                                                   
							getPropertyValue("masPrevisualizados_Federado_semana_rss.fileName"), getPropertyValue("masPrevisualizados_Federado_semana_atom.fileName"),idioma);                                                                                                                                                                                         
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más previsualizados SEMANA: ", e);                                                                                                                                                                                                                                  
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas previsualizados MES...");                                                                                                                                                                                                                                                         
		        	parametrosInformeVO.setFechaDesde(calendar_mes);                                                                                                                                                                                                                                                                                                            
		        	masPrevisualizados = srvAuditoriaServicio.informeMasPrevisualizados(parametrosInformeVO);                                                                                                                                                                                                                                                                   
		        	crearXMLauditoria(masPrevisualizados,                                                                                                                                                                                                                                                                                                                       
		            		"masPrevisualizados_mes.title", getPropertyValue("masPrevisualizados.url"), traduceEtiqueta("masPrevisualizados_mes.descripcion",idioma),                                                                                                                                                                                                        
		            		getPropertyValue("masPrevisualizados_mes_rss.fileName"), getPropertyValue("masPrevisualizados_mes_atom.fileName"),idioma);                                                                                                                                                                                                                                 
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más previsualizados MES: ", e);                                                                                                                                                                                                                                               
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
					log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas previsualizados MES...");                                                                                                                                                                                                                                       
		        	crearXMLauditoriaFederada(getPropertyValue("masPrevisualizados_mes_rss.fileName"), "masPrevisualizados_Federado_mes.title",                                                                                                                                                                                                                                 
							getPropertyValue("masPrevisualizados_Federado.url"), traduceEtiqueta("masPrevisualizados_Federado_mes.descripcion",idioma),                                                                                                                                                                                                      
							getPropertyValue("masPrevisualizados_Federado_mes_rss.fileName"), getPropertyValue("masPrevisualizados_Federado_mes_atom.fileName"),idioma);                                                                                                                                                                                               
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más previsualizados MES: ", e);                                                                                                                                                                                                                                     
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		InformeMasVO[] masEnviados = null;                                                                                                                                                                                                                                                                                                                                  
	    		try{                                                                                                                                                                                                                                                                                                                                                                
//		        	//MAS ENVIADOS                                                                                                                                                                                                                                                                                                                                              
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas enviados AÑO...");                                                                                                                                                                                                                                                                
		        	parametrosInformeVO.setFechaDesde(calendar_anio);                                                                                                                                                                                                                                                                                                           
		        	masEnviados = srvAuditoriaServicio.informeMasEnviado(parametrosInformeVO);                                                                                                                                                                                                                                                                                  
		        	crearXMLauditoria(masEnviados,                                                                                                                                                                                                                                                                                                                              
		            		"masEnviados_anio.title", getPropertyValue("masEnviados.url"), traduceEtiqueta("masEnviados_anio.descripcion",idioma),                                                                                                                                                                                                                           
		            		getPropertyValue("masEnviados_anio_rss.fileName"), getPropertyValue("masEnviados_anio_atom.fileName"),idioma);                                                                                                                                                                                                                                             
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más enviados AÑO: ", e);                                                                                                                                                                                                                                                      
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
//		        	//MAS ENVIADOS                                                                                                                                                                                                                                                                                                                                              
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas enviados...AÑO");                                                                                                                                                                                                                                                       
	    			crearXMLauditoriaFederada(getPropertyValue("masEnviados_anio_rss.fileName"), "masEnviados_Federado_anio.title",                                                                                                                                                                                                                                             
							getPropertyValue("masEnviados_Federado.url"), traduceEtiqueta("masEnviados_Federado_anio.descripcion",idioma),                                                                                                                                                                                                                   
							getPropertyValue("masEnviados_Federado_anio_rss.fileName"), getPropertyValue("masEnviados_Federado_anio_atom.fileName"),idioma);                                                                                                                                                                                                           
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más enviados AÑO: ", e);                                                                                                                                                                                                                                            
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas enviados SEMANA con idioma="+idioma);                                                                                                                                                                                                                                                             
	    			parametrosInformeVO.setFechaDesde(calendar_semana);                                                                                                                                                                                                                                                                                                         
		        	masEnviados = srvAuditoriaServicio.informeMasEnviado(parametrosInformeVO);                                                                                                                                                                                                                                                                                  
		        	crearXMLauditoria(masEnviados,                                                                                                                                                                                                                                                                                                                              
		            		"masEnviados_semana.title", getPropertyValue("masEnviados.url"), traduceEtiqueta("masEnviados_semana.descripcion",idioma),                                                                                                                                                                                                                       
		            		getPropertyValue("masEnviados_semana_rss.fileName"), getPropertyValue("masEnviados_semana_atom.fileName"),idioma);                                                                                                                                                                                                                                         
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más enviados SEMANA: ", e);                                                                                                                                                                                                                                                   
	    		}                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas enviados SEMANA...");                                                                                                                                                                                                                                                   
	    			crearXMLauditoriaFederada(getPropertyValue("masEnviados_semana_rss.fileName"), "masEnviados_Federado_semana.title",                                                                                                                                                                                                                                         
							getPropertyValue("masEnviados_Federado.url"), traduceEtiqueta("masEnviados_Federado_semana.descripcion",idioma),                                                                                                                                                                                                                 
							getPropertyValue("masEnviados_Federado_semana_rss.fileName"), getPropertyValue("masEnviados_Federado_semana_atom.fileName"),idioma);                                                                                                                                                                                                       
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más enviados SEMANA: ", e);                                                                                                                                                                                                                                         
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
	    			log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes mas enviados MES...");                                                                                                                                                                                                                                                                
		        	parametrosInformeVO.setFechaDesde(calendar_mes);                                                                                                                                                                                                                                                                                                            
		        	masEnviados = srvAuditoriaServicio.informeMasEnviado(parametrosInformeVO);                                                                                                                                                                                                                                                                                  
		        	crearXMLauditoria(masEnviados,                                                                                                                                                                                                                                                                                                                              
		            		"masEnviados_mes.title", getPropertyValue("masEnviados.url"), traduceEtiqueta("masEnviados_mes.descripcion",idioma),                                                                                                                                                                                                                             
		            		getPropertyValue("masEnviados_mes_rss.fileName"), getPropertyValue("masEnviados_mes_atom.fileName"),idioma);                                                                                                                                                                                                                                               
				} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs más enviados MES: ", e);                                                                                                                                                                                                                                                      
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	    		try{                                                                                                                                                                                                                                                                                                                                                                
					log("SrvAgregadorRssServiceImpl - crearXML: generando feed odes federados mas enviados MES...");                                                                                                                                                                                                                                              
		        	crearXMLauditoriaFederada(getPropertyValue("masEnviados_mes_rss.fileName"), "masEnviados_Federado_mes.title",                                                                                                                                                                                                                                               
							getPropertyValue("masEnviados_Federado.url"), traduceEtiqueta("masEnviados_Federado_mes.descripcion",idioma),                                                                                                                                                                                                                    
							getPropertyValue("masEnviados_Federado_mes_rss.fileName"), getPropertyValue("masEnviados_Federado_mes_atom.fileName"),idioma);                                                                                                                                                                                                             
	    		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                              
	    			logger.error("[CREARXML] Se ha producido un error al recuperar los datos de ODEs federados más enviados MES: ", e);                                                                                                                                                                                                                                            
	    		}                                                                                                                                                                                                                                                                                                                                                                   
	    		                                                                                                                                                                                                                                                                                                                                                                    
        	} catch (Exception e){                                                                                                                                                                                                                                                                                                                                                      
        		logger.error("[CREARXML] Se ha producido un error --> " + e);                                                                                                                                                                                                                                                                                                          
        		throw e;                                                                                                                                                                                                                                                                                                                                                            
        	}                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                                                                                                                                                   
        catch (IOException ex) {                                                                                                                                                                                                                                                                                                                                                            
    		logger.error("[CREARXML] Se ha producido un error al acceder a los ficheros de configuración --> " + ex);                                                                                                                                                                                                                                                                      
    		throw ex;                                                                                                                                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
        catch (Exception ex) {                                                                                                                                                                                                                                                                                                                                                              
    		logger.error("[CREARXML] Se ha producido un error --> " + ex);                                                                                                                                                                                                                                                                                                                 
    		throw ex;                                                                                                                                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                                                                                                                                                       
	                                                                                                                                                                                                                                                                                                                                                                                    
	private NoticiaTraducidaVO[] obtenerNoticias() throws Exception{                                                                                                                                                                                                                                                                                                                    
		                                                                                                                                                                                                                                                                                                                                                                            
		SrvNoticiasService srNoticiasService = this.getSrvNoticiasService();                                                                                                                                                                                                                                                                                                        
		                                                                                                                                                                                                                                                                                                                                                                            
//		OBTENEMOS LOS IDIOMAS TRADUCIBLES                                                                                                                                                                                                                                                                                                                                           
		log("Obtenemos los idiomas traducibles");                                                                                                                                                                                                                                                                                             
		String[] idiomasPlataforma = I18n.getInstance().obtenerIdiomasPlataforma();                                                                                                                                                                                                                                                                                                 
		log("Hay ["+idiomasPlataforma.length+"] en la plataforma");                                                                                                                                                                                                                                                                           
		String idiomaPrioritario = I18n.getInstance().obtenerIdiomaDefectoPlataforma();                                                                                                                                                                                                                                                                                             
		String idiomaSecundario = I18n.getInstance().obtenerIdiomaSecundarioPlataforma();                                                                                                                                                                                                                                                                                           
		log("idioma prioritario de la plataforma es ["+idiomaPrioritario+"] y el secundario es ["+idiomaSecundario+"]");                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                            
        //OBTENEMOS LAS NOTICIAS                                                                                                                                                                                                                                                                                                                                                            
		NoticiaTraducidaVO[] noticiasTraducidas = srNoticiasService.obtenerNoticiasTraducidas(devuelveIdiomasTraducibles(idiomasPlataforma, idiomaPrioritario, idiomaSecundario));                                                                                                                                                                                                  
		boolean encontrado=false;                                                                                                                                                                                                                                                                                                                                                   
		int cont=0;                                                                                                                                                                                                                                                                                                                                                                 
		List noticiasActivas = new ArrayList();                                                                                                                                                                                                                                                                                                                                     
		for (int i=0;i<noticiasTraducidas.length || encontrado;i++){                                                                                                                                                                                                                                                                                                                
			if (noticiasTraducidas[i].getActiva()){                                                                                                                                                                                                                                                                                                                             
				noticiasActivas.add(noticiasTraducidas[i]);                                                                                                                                                                                                                                                                                                                 
				cont=cont +1;                                                                                                                                                                                                                                                                                                                                               
				if (cont ==10) encontrado=true;                                                                                                                                                                                                                                                                                                                             
			}                                                                                                                                                                                                                                                                                                                                                                   
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
		NoticiaTraducidaVO[] noticias = new NoticiaTraducidaVO[noticiasActivas.size()];                                                                                                                                                                                                                                                                                             
		for (int i=0;i<noticiasActivas.size();i++){                                                                                                                                                                                                                                                                                                                                 
			noticias[i] = (NoticiaTraducidaVO) noticiasActivas.get(i);			                                                                                                                                                                                                                                                                                    
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
		                                                                                                                                                                                                                                                                                                                                                                            
		return noticias;                                                                                                                                                                                                                                                                                                                                                            
		                                                                                                                                                                                                                                                                                                                                                                            
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String[] devuelveIdiomasTraducibles(String[] idiomas, String idiomaPrioritario, String idiomaSecundario) throws Exception  {                                                                                                                                                                                                                                                
		ArrayList idiomasList = new ArrayList();                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                            
		if (idiomaPrioritario.equals(idiomaSecundario)){                                                                                                                                                                                                                                                                                                                            
			idiomasList.add(idiomaPrioritario);                                                                                                                                                                                                                                                                                                                                 
		}else{                                                                                                                                                                                                                                                                                                                                                                      
			idiomasList.add(idiomaPrioritario);                                                                                                                                                                                                                                                                                                                                 
			idiomasList.add(idiomaSecundario);                                                                                                                                                                                                                                                                                                                                  
		}                                                                                                                                                                                                                                                                                                                                                                           
        String[] idiomasArray = devuelveArraySinIdiomasPrioritarios(idiomas, idiomasList);                                                                                                                                                                                                                                                                                                  
        for (int i = 0;idiomasArray != null && i < idiomasArray.length; i++)                                                                                                                                                                                                                                                                                                                
        	idiomasList.add(idiomasArray[i]);                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
        return (String[])idiomasList.toArray(new String[0]);                                                                                                                                                                                                                                                                                                                                
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
    private String[] devuelveArraySinIdiomasPrioritarios (String[] idiomas, ArrayList listaIdiomas) throws Exception {                                                                                                                                                                                                                                                                      
    	ArrayList listaAux = new ArrayList();                                                                                                                                                                                                                                                                                                                                               
    	listaAux = devuelveArraySinString(idiomas, (String)listaIdiomas.get(0));                                                                                                                                                                                                                                                                                                            
    	for (int i = 1; i < listaIdiomas.size(); i++) {                                                                                                                                                                                                                                                                                                                                     
    		listaAux = devuelveArraySinString((String[])listaAux.toArray(new String[0]), (String)listaIdiomas.get(i));                                                                                                                                                                                                                                                                  
    	}                                                                                                                                                                                                                                                                                                                                                                                   
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	return (String[])listaAux.toArray(new String[0]);                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
    private ArrayList devuelveArraySinString (String[] idiomas, String stringBorrar) throws Exception {                                                                                                                                                                                                                                                                                     
    	ArrayList idiomasReturn = new ArrayList();                                                                                                                                                                                                                                                                                                                                          
    	for (int i = 0; idiomas != null && i < idiomas.length; i++)	{                                                                                                                                                                                                                                                                                                                   
    		if (!(idiomas[i].equals(stringBorrar)))                                                                                                                                                                                                                                                                                                                                     
    			idiomasReturn.add(idiomas[i]);                                                                                                                                                                                                                                                                                                                                      
    	}                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
    	return idiomasReturn;                                                                                                                                                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
	                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                            
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Crea los xmls correspondientes a los informes de auditoría formato RSS y ATOM                                                                                                                                                                                                                                                                                                    
	 * @param  	Object[] odes: array de odes que formarán el feed                                                                                                                                                                                                                                                                                                                   
	 * 			String titulo: titulo del feed                                                                                                                                                                                                                                                                                                                              
	 * 			String link: link del feed                                                                                                                                                                                                                                                                                                                                  
	 * 			String descripcion: descripción del feed                                                                                                                                                                                                                                                                                                                    
	 * 			String fileNameRss: nombre del fichero para el formato RSS                                                                                                                                                                                                                                                                                                  
	 * 			String fileNameAtom: nombre del fichero para el formato ATOM                                                                                                                                                                                                                                                                                                
	 * @return void                                                                                                                                                                                                                                                                                                                                                                     
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private void crearXMLauditoria (Object[] odes, String titulo, String link, String descripcion, String fileNameRss, String fileNameAtom,String idioma) throws Exception {                                                                                                                                                                                                                              
    	String idODE;                                                                                                                                                                                                                                                                                                                                                                       
    	String numVeces = "";                                                                                                                                                                                                                                                                                                                                                               
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	Date fecha = new Date();                                                                                                                                                                                                                                                                                                                                                            
    	                                                                                                                                                                                                                                                                                                                                                                                    
        try{                                                                                                                                                                                                                                                                                                                                                                                
			log("SrvAgregadorRssServiceImpl - crearXMLauditoria: comienza a crear el feed... " + titulo);                                                                                                                                                                                                                                                                 
	        feed.setLink("http://" + feedHost + formatearMensaje(link, new String[]{feedHost}));
	        feed.setAuthor("Agrega");
	        feed.setPublishedDate(new Date());
//	        feed.setDescription(descripcion);                                                                                                                                                                                                                                                                                                                                           
	                                                                                                                                                                                                                                                                                                                                                                                    
	        List entries = new ArrayList();                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                            
	        SyndEntry entry;                                                                                                                                                                                                                                                                                                                                                            
	        SyndImageImpl image = new SyndImageImpl();                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                            
	        SyndContent description;                                                                                                                                                                                                                                                                                                                                                    
	        SyndContent imagenItem;                                                                                                                                                                                                                                                                                                                                                     
	                                                                                                                                                                                                                                                                                                                                                                                    
	        MetadatoBasicoVO metaBasicoVO = null;                                                                                                                                                                                                                                                                                                                                       
	        if (odes != null){      
	        	int contOdeBuenos=0;
	        	log("Inicializando el contador de Odes buenos con valor: " + contOdeBuenos);
		        for (int i=0; i<odes.length && contOdeBuenos<10 ;i++){                                                                                                                                                                                                                                                                                                                                   
		            if (odes instanceof InformeMasVO[]){                                                                                                                                                                                                                                                                                                                            
		            	idODE = ((InformeMasVO)odes[i]).getIdOde();                                                                                                                                                                                                                                                                                                                 
		            	idioma = ((InformeMasVO)odes[i]).getIdioma();                                                                                                                                                                                                                                                                                                               
		            	if (idioma == null || idioma.equals(""))                                                                                                                                                                                                                                                                                                                    
		            		log("No tiene idioma!!!");                                                                                                                                                                                                                                                                                                                    
		            	numVeces=numVeces.valueOf(((InformeMasVO)odes[i]).getNumVeces());                                                                                                                                                                                                                                                                                           
		            }else{                                                                                                                                                                                                                                                                                                                                                          
		            	idODE = ((OdePublicadoVO)odes[i]).getIdODE();                                                                                                                                                                                                                                                                                                               
		            	idioma = ((OdePublicadoVO)odes[i]).getIdioma();                                                                                                                                                                                                                                                                                                             
		            	fecha = ((OdePublicadoVO)odes[i]).getFecha().getTime();                                                                                                                                                                                                                                                                                                     
		            }                                                                                                                                                                                                                                                                                                                                                               
		            log("Se lanza getSrvBuscarService.solicitarMetadato con los siguientes datos: ");                                                                                                                                                                                                                                                                         
		            log("idODE = " + idODE);                                                                                                                                                                                                                                                                                                                                  
		            log("idioma = " + idioma);                                                                                                                                                                                                                                                                                                                                
		            log("numVeces = " + numVeces);                                                                                                                                                                                                                                                                                                                            
		            log("fecha = " + fecha);                                                                                                                                                                                                                                                                                                                                  
		            entry = new SyndEntryImpl();                                                                                                                                                                                                                                                                                                                                    
		        	try{                                                                                                                                                                                                                                                                                                                                                        
		        		metaBasicoVO =  this.getSrvBuscarService().solicitarMetadato(new ParametroMetadatoVO(idODE, idioma,""));                                                                                                                                                                                                                                            
			        	if (metaBasicoVO!=null){
			        		log("tenemos todos los datos necesarios del ODE con identificador: " + metaBasicoVO.getIdentificadorODE() + ", idioma: " + metaBasicoVO.getIdioma());                                                                                                                                                                                         
				            entry.setTitle(metaBasicoVO.getTitulo());                                                                                                                                                                                                                                                                                                               
				            entry.setLink(formarURLodes() + "/" + idioma + "/" +metaBasicoVO.getIdentificadorODE());                                                                                                                                                                                                                                                                
				                                                                                                                                                                                                                                                                                                                                                                    
				            Date fechayHoraPublicacion = null;                                                                                                                                                                                                                                                                                                                                                        
		        			if (titulo.equals("ultimosOdes.title")){
					            SimpleDateFormat formatoFechayHora = new SimpleDateFormat("yyyyMMdd" + " " + "HHmmss");                                                                                                                                                                                                                                                             
			        			fechayHoraPublicacion = formatoFechayHora.parse(metaBasicoVO.getFechaPublicacion() + " " + metaBasicoVO.getHoraPublicacion());                                                                                                                                                                                                                 
					            entry.setUpdatedDate(fechayHoraPublicacion);                                                                                                                                                                                                                                                                                                            
					            entry.setPublishedDate(fechayHoraPublicacion);
		        			}
				                                                                                                                                                                                                                                                                                                                                                                    
				            if (odes instanceof InformeMasVO[]){                                                                                                                                                                                                                                                                                                                    
				            	entry.setUri(numVeces);                                                                                                                                                                                                                                                                                                                             
				            }else{                                                                                                                                                                                                                                                                                                                                                  
				            	entry.setPublishedDate(fechayHoraPublicacion);                                                                                                                                                                                                                                                                                                      
				            	entry.setUri("0");                                                                                                                                                                                                                                                                                                                                  
				            }			                                                                                                                                                                                                                                                                                                                                    
				                                                                                                                                                                                                                                                                                                                                                                    
				            log("Se crea la imagen");                                                                                                                                                                                                                                                                                                                         
				            image.setUrl(http + feedHost + "/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                                      
				            image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                                         
				            image.setTitle("");                                                                                                                                                                                                                                                                                                                                     
				                                                                                                                                                                                                                                                                                                                                                                    
				                                                                                                                                                                                                                                                                                                                                                                    
				            imagenItem = new SyndContentImpl();                                                                                                                                                                                                                                                                                                                     
				            imagenItem.setType("html");                                                                                                                                                                                                                                                                                                                             
				            imagenItem.setMode("escaped");                                                                                                                                                                                                                                                                                                                          
				            if (metaBasicoVO.getImagen()!=null && !metaBasicoVO.getImagen().equals("")){                                                                                                                                                                                                                                                                            
				            	
				            	String fdf=comprobarImagen(feedHost, metaBasicoVO.getImagen());
				            	String fdfamplia="";
				            	if(fdf.equals(metaBasicoVO.getImagen()))fdfamplia=ampliarImagen(metaBasicoVO.getImagen());
				            	else fdfamplia=fdf;
				            	//imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + ampliarImagen(metaBasicoVO.getImagen()) + "'target='_blank'><img src='" + http + feedHost + metaBasicoVO.getImagen() + "'/></a></p>" + metaBasicoVO.getDescripcion());                                                                                                  
				            	imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + fdfamplia + "'target='_blank'><img src='" + http + feedHost + fdf + "'/></a></p>" + metaBasicoVO.getDescripcion());
				            	
				            	
				            	
				            	log("se inserta la imagen");                                                                                                                                                                                                                                                                                                                  
				            }else{                                                                                                                                                                                                                                                                                                                                                  
				            	imagenItem.setValue("");                                                                                                                                                                                                                                                                                                                            
				            	log("no tiene imagen");                                                                                                                                                                                                                                                                                                                       
				            }                                                                                                                                                                                                                                                                                                                                                       
				                                                                                                                                                                                                                                                                                                                                                                    
				            List contenido = new ArrayList();                                                                                                                                                                                                                                                                                                                       
				            contenido.add(imagenItem);                                                                                                                                                                                                                                                                                                                              
				            entry.setContents(contenido);
				            entries.add(entry);
				            contOdeBuenos=contOdeBuenos + 1;
				            log("Nuevo ode bueno cargado. Ahora llevamos " +contOdeBuenos+ " odes correctos cargados");
			        	} else {
			        		throw new Exception ("el resultado de la búsqueda es null");
			        	}
			         			         			                                                                                                                                                                                                                                                                                                    
		        	} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
		        		logger.error("No hemos podido recuperar los datos del ODE: ", e);                                                                                                                                                                                                                                                                                      
			            log("Nuevo Ode erroneo");
		        	}
		        }                                                                                                                                                                                                                                                                                                                                                                   
		                                                                                                                                                                                                                                                                                                                                                                            
	        } else {                                                                                                                                                                                                                                                                                                                                                                    
	        	logger.info("SrvAgregadorRssServiceImpl - crearXMLauditoria: no hay datos para generar el feed ATOM: " + titulo);                                                                                                                                                                                                                                                      
	        	entry = new SyndEntryImpl();                                                                                                                                                                                                                                                                                                                                        
        		log("No hay items para mostrar");                                                                                                                                                                                                                                                                                                                             
	            entry.setTitle(traduceEtiqueta("no_hay_items",idioma));                                                                                                                                                                                                                                                                                                              
	            entry.setLink("");                                                                                                                                                                                                                                                                                                                                                      
	            entry.setUri("0");                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                            
	            image.setUrl(http + feedHost +"/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                                                       
	            image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                                                         
	            image.setTitle("");                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                          
	            imagenItem = new SyndContentImpl();                                                                                                                                                                                                                                                                                                                                     
	            imagenItem.setType("html");                                                                                                                                                                                                                                                                                                                                             
	            imagenItem.setMode("escaped");                                                                                                                                                                                                                                                                                                                                          
	            imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost +"/galeriaimg/es_20080729_1_9173013/es_20080729_1_9173013.png' target='_blank'><img src='" + http + feedHost +"/galeriaimg/es_20080729_1_9173013/es_20080729_1_9173013.png'/></a></p>");                
                                                                                                                                                                                                                                                                                                                                                                                            
	        	List contenido = new ArrayList();                                                                                                                                                                                                                                                                                                                                   
	            contenido.add(imagenItem);                                                                                                                                                                                                                                                                                                                                              
	            entry.setContents(contenido);                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
	            entries.add(entry);                                                                                                                                                                                                                                                                                                                                                     
	        }                                                                                                                                                                                                                                                                                                                                                                           
	        //Escribimos en el fichero                                                                                                                                                                                                                                                                                                                                                  
		                                                                                                                                                                                                                                                                                                                                                                            
	        log("comenzamos a generar los ficheros...");                                                                                                                                                                                                                                                                                                                          
	        feed.setEntries(entries);                                                                                                                                                                                                                                                                                                                                                   
	        feed.setImage(image);                                                                                                                                                                                                                                                                                                                                                       
	        feed.setDescription(descripcion);                                                                                                                                                                                                                                                                                                                                           
	        //RSS                                                                                                                                                                                                                                                                                                                                                                       
	    	feed.setTitle(traduceEtiqueta(titulo + "_rss",idioma));                                                                                                                                                                                                                                                                                                                  
            feed.setFeedType(getPropertyValue("feedTypeRSS"));                                                                                                                                                                                                                                                                                                                              
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando: " + feedPath + fileNameRss);                                                                                                                                                                                                                                                                          
	        Writer writer = new FileWriter(feedPath + fileNameRss);                                                                                                                                                                                                                                                                                                                     
	        SyndFeedOutput output = new SyndFeedOutput();                                                                                                                                                                                                                                                                                                                               
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
			log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando correctamente feed RSS: " + titulo);                                                                                                                                                                                                                                                           
	        //ATOM                                                                                                                                                                                                                                                                                                                                                                      
	    	feed.setTitle(traduceEtiqueta(titulo + "_atom",idioma));                                                                                                                                                                                                                                                                                                                 
            feed.setFeedType(getPropertyValue("feedTypeAtom"));                                                                                                                                                                                                                                                                                                                             
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando: " + feedPath + fileNameAtom);                                                                                                                                                                                                                                                                         
	        writer = new FileWriter(feedPath + fileNameAtom);                                                                                                                                                                                                                                                                                                                           
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
			log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando correctamente feed ATOM: " + titulo);                                                                                                                                                                                                                                                          
        }catch (Exception e){                                                                                                                                                                                                                                                                                                                                                               
        	logger.error("[CREARXMLauditoria] Se ha producido un error al crear el fichero: " + titulo + "--> ", e);                                                                                                                                                                                                                                                                       
        }
    }         
    
    private String comprobarImagen(String servidor, String imagen){
        try{
              InputStreamReader in = new InputStreamReader(new URL("http://"+servidor+imagen).openStream());
              return imagen;
        }catch(Exception ex){
              return "/"+AgregaPropertiesImpl.getInstance().getProperty(AgregaProperties.URL_IMAGEN_DEFECTO_100x100);
        }
  }
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Genera a partir de la URL de la imagen pequeña la URL de la imagen ampliada                                                                                                                                                                                                                                                                                                      
	 * @param String con la URL de la imagen pequeña                                                                                                                                                                                                                                                                                                                                    
	 * @return String con la url ampliada que se abrirá en otra ventana                                                                                                                                                                                                                                                                                                                 
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private String ampliarImagen (String url){                                                                                                                                                                                                                                                                                                                                              
    	if(url!=null && !("").equals(url)){                                                                                                                                                                                                                                                                                                                                                 
			String urlImagenReturn = "";                                                                                                                                                                                                                                                                                                                                        
			String[] urlImagenArray = url.split(PUNTO);                                                                                                                                                                                                                                                                                                                         
			for(int i=0; urlImagenArray!=null && i<urlImagenArray.length; i++){                                                                                                                                                                                                                                                                                                 
				if(urlImagenArray[i].equals(IMAGEN_MINIMIZADA))                                                                                                                                                                                                                                                                                                             
					urlImagenArray[i] = IMAGEN_AMPLIADA;                                                                                                                                                                                                                                                                                                                
				urlImagenReturn = urlImagenReturn + urlImagenArray[i];                                                                                                                                                                                                                                                                                                      
			}                                                                                                                                                                                                                                                                                                                                                                   
			return(urlImagenReturn.trim());                                                                                                                                                                                                                                                                                                                                     
		}                                                                                                                                                                                                                                                                                                                                                                           
    	return "";                                                                                                                                                                                                                                                                                                                                                                          
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Crea los xmls correspondientes a los informes de auditoría formato RSS y ATOM de forma federada                                                                                                                                                                                                                                                                                  
	 * @param  	String fileName: nombre del fichero a recuperar                                                                                                                                                                                                                                                                                                                     
	 * 			String titulo: titulo del feed                                                                                                                                                                                                                                                                                                                              
	 * 			String link: link del feed                                                                                                                                                                                                                                                                                                                                  
	 * 			String descripcion: descripción del feed                                                                                                                                                                                                                                                                                                                    
	 * 			String fileNameRss: nombre del fichero federado para el formato RSS                                                                                                                                                                                                                                                                                         
	 * 			String fileNameAtom: nombre del fichero federado para el formato ATOM                                                                                                                                                                                                                                                                                       
	 * @return void                                                                                                                                                                                                                                                                                                                                                                     
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private void crearXMLauditoriaFederada (String fileName,String titulo,String link, String descripcion, String fileNameRss, String fileNameAtom,String idioma) throws Exception {                                                                                                                                                                                                                      
    	   	                                                                                                                                                                                                                                                                                                                                                                            
        try{                                                                                                                                                                                                                                                                                                                                                                                
    		log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Inicio.");                                                                                                                                                                                                                                                                      
    		NodoVO[] nodosDB=this.getSrvNodoService().listarNodos();                                                                                                                                                                                                                                                                                                                    
    		NodoVO[] nodos;                                                                                                                                                                                                                                                                                                                                                             
    		if (nodosDB!=null){                                                                                                                                                                                                                                                                                                                                                         
    			nodos=new NodoVO[nodosDB.length+1];                                                                                                                                                                                                                                                                                                                                 
    		}else{                                                                                                                                                                                                                                                                                                                                                                      
    			nodos=new NodoVO[1];                                                                                                                                                                                                                                                                                                                                                
    		}                                                                                                                                                                                                                                                                                                                                                                           
    		NodoVO nodoLocal=new NodoVO();                                                                                                                                                                                                                                                                                                                                              
    		nodoLocal.setUrl(feedHost);                                                                                                                                                                                                                                                                                                                                                 
    		nodos[0]=nodoLocal;                                                                                                                                                                                                                                                                                                                                                         
    		log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Recuperadas comunidades federadas.");                                                                                                                                                                                                                                           
    		for (int i=1; i<nodos.length; i++){                                                                                                                                                                                                                                                                                                                                         
    			nodos[i]=nodosDB[i-1];                                                                                                                                                                                                                                                                                                                                              
    		}                                                                                                                                                                                                                                                                                                                                                                           
    		List todosEntries = new ArrayList();                                                                                                                                                                                                                                                                                                                                        
    		URL feedUrl = null;                                                                                                                                                                                                                                                                                                                                         
        	for (int i=0; i<nodos.length; i++){                                                                                                                                                                                                                                                                                                                                       
        		try{                                                                                                                                                                                                                                                                                                                                                                
	        		rssPath=nodos[i].getUrl();                                                                                                                                                                                                                                                                                                                                  
	        		feedUrl = new URL(http + rssPath+ rss +"/"+ fileName);                                                                                                                                                                                                                                                                                                  
	        		SyndFeedInput input = new SyndFeedInput();                                                                                                                                                                                                                                                                                                                  
	        		String rutaFichero=http + rssPath+ rss +"/"+ fileName;                                                                                                                                                                                                                                                                                                      
	        		try{                                                                                                                                                                                                                                                                                                                                                        
		        		SyndFeed feedPrivado = input.build(new XmlReader(feedUrl));                                                                                                                                                                                                                                                                                         
		        		List entries = feedPrivado.getEntries();                                                                                                                                                                                                                                                                                                            
		        		log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Recuperando listado de odes de todas las comunidades.");                                                                                                                                                                                                
		        		for (int j=0;j<entries.size();j++){                                                                                                                                                                                                                                                                                                                 
		        			todosEntries.add(entries.get(j));                                                                                                                                                                                                                                                                                                           
		        		}                                                                                                                                                                                                                                                                                                                                                   
	        		}catch (Exception e){                                                                                                                                                                                                                                                                                                                                       
	        			logger.error("[CREARXMLauditoriaFederada1] Se ha producido un error al leer el fichero: "+feedUrl.getPath()+" del servidor:"+http + rssPath+" con titulo: " + titulo + " --> ", e);                                                                                                                                                                                                             
	        		}                                                                                                                                                                                                                                                                                                                                                           
        		}catch(Exception e){                                                                                                                                                                                                                                                                                                                                                
        			logger.error("[CREARXMLauditoriaFederada2] Se ha producido un error al leer el fichero: "+feedUrl.getPath()+" del servidor:"+http + rssPath+" con titulo: " + titulo + " --> ", e);                                                                                                                                                                                                                     
        		}                                                                                                                                                                                                                                                                                                                                                                   
        	}                                                                                                                                                                                                                                                                                                                                                                           
//        	aqui hay que se ordena la lista y luego nos quedamos con los primeros diez elementos                                                                                                                                                                                                                                                                                        
//        	que son los que hay que escribir en el fichero                                                                                                                                                                                                                                                                                                                              
        	                                                                                                                                                                                                                                                                                                                                                                            
        	if ((((SyndEntryImpl)todosEntries.get(0)).getUri())!= null && !(((SyndEntryImpl)todosEntries.get(0)).getUri().equals(""))){                                                                                                                                                                                                                                                 
        		Collections.sort(todosEntries, new NumVecesComparator());                                                                                                                                                                                                                                                                                                           
        		log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Ordenando lista odes más...");                                                                                                                                                                                                                                          
        	}else                                                                                                                                                                                                                                                                                                                                                                       
        		Collections.sort(todosEntries, new FechaComparator());                                                                                                                                                                                                                                                                                                              
        		log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Ordenando lista últimos odes publicados.");                                                                                                                                                                                                                                     
        	                                                                                                                                                                                                                                                                                                                                                                            
        	List listaOrdenada=new ArrayList();                                                                                                                                                                                                                                                                                                                                         
//        	if (todosEntries.size()==10){                                                                                                                                                                                                                                                                                                                                               
//        		listaOrdenada=todosEntries;                                                                                                                                                                                                                                                                                                                                         
//        	}else{                                                                                                                                                                                                                                                                                                                                                                      
//        		for (int i=0;i<todosEntries.size()&& i<10;i++){                                                                                                                                                                                                                                                                                                                     
//        			listaOrdenada.add(todosEntries.get(i));                                                                                                                                                                                                                                                                                                                     
//        		}                                                                                                                                                                                                                                                                                                                                                                   
//        	}                   
        	
    		for (int i=0, j=0;i<todosEntries.size()&& j<10;i++){                                                                                                                                                                                                                                                                                                                        
    			SyndEntry entry = (SyndEntry)todosEntries.get(i);                                                                                                                                                                                                                                                                                                                   
    			if (!entry.getTitle().equals(traduceEtiqueta("no_hay_items",idioma))){                                                                                                                                                                                                                                                                                           
    				listaOrdenada.add(todosEntries.get(i));                                                                                                                                                                                                                                                                                                                     
    				j++;                                                                                                                                                                                                                                                                                                                                                        
    			}                                                                                                                                                                                                                                                                                                                                                                   
    		}                                                                                                                                                                                                                                                                                                                                                                           
        	                                                                                                                                                                                                                                                                                                                                                                            
        	SyndImageImpl image = new SyndImageImpl();                                                                                                                                                                                                                                                                                                                                  
        	image.setUrl(http + feedHost +"/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                                                           
            image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                                                                 
            image.setTitle("");                                                                                                                                                                                                                                                                                                                                                             
        	                                                                                                                                                                                                                                                                                                                                                                            
//        	escribimos el fichero xml con los datos de la lista                                                                                                                                                                                                                                                                                                                         
        	log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: comienza a crear el fichero xml");                                                                                                                                                                                                                                             
	        feed.setLink("http://" + feedHost + formatearMensaje(link, new String[]{feedHost}));                                                                                                                                                                                                                                                                                        
	        feed.setDescription(descripcion);                                                                                                                                                                                                                                                                                                                                           
        	feed.setImage(image);                                                                                                                                                                                                                                                                                                                                                       
        	feed.setAuthor("Agrega");
	        feed.setPublishedDate(new Date());                                                                                                                                                                                                                                                                                                                                                                     
//	        Escribimos en el fichero                                                                                                                                                                                                                                                                                                                                                    
	        log("comenzamos a generar los ficheros...");                                                                                                                                                                                                                                                                                                
	        feed.setEntries(listaOrdenada);                                                                                                                                                                                                                                                                                                                                             
	        //RSS                                                                                                                                                                                                                                                                                                                                                                       
	    	feed.setTitle(traduceEtiqueta(titulo + "_rss",idioma));                                                                                                                                                                                                                                                                                                                  
            feed.setFeedType(getPropertyValue("feedTypeRSS"));                                                                                                                                                                                                                                                                                                                              
            log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: generando: " + feedPath + fileNameRss);                                                                                                                                                                                                                                            
	        Writer writer = new FileWriter(feedPath + fileNameRss);                                                                                                                                                                                                                                                                                                                     
	        SyndFeedOutput output = new SyndFeedOutput();                                                                                                                                                                                                                                                                                                                               
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: generando correctamente feed RSS: " + titulo);                                                                                                                                                                                                                                 
	        //ATOM                                                                                                                                                                                                                                                                                                                                                                      
	    	feed.setTitle(traduceEtiqueta(titulo + "_atom",idioma));                                                                                                                                                                                                                                                                                                                 
            feed.setFeedType(getPropertyValue("feedTypeAtom"));                                                                                                                                                                                                                                                                                                                             
            log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: generando: " + feedPath + fileNameAtom);                                                                                                                                                                                                                                           
	        writer = new FileWriter(feedPath + fileNameAtom);                                                                                                                                                                                                                                                                                                                           
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: generando correctamente feed ATOM: " + titulo);                                                                                                                                                                                                                                
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoriaFederada: Fin.");                                                                                                                                                                                                                                                                         
        }catch (Exception e){                                                                                                                                                                                                                                                                                                                                                               
        	logger.error("[CREARXMLauditoriaFederada] Se ha producido un error al crear el fichero: " + titulo + " --> ", e);                                                                                                                                                                                                                                    
        }                                                                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Crea los xmls correspondientes a las noticias formato RSS y ATOM                                                                                                                                                                                                                                                                                                                 
	 * @param  	NoticiaListableVO[] noticias: array de noticias que formarán el feed                                                                                                                                                                                                                                                                                                
	 * 			String titulo: titulo del feed                                                                                                                                                                                                                                                                                                                              
	 * 			String link: link del feed                                                                                                                                                                                                                                                                                                                                  
	 * 			String descripcion: descripción del feed                                                                                                                                                                                                                                                                                                                    
	 * 			String fileNameRss: nombre del fichero para el formato RSS                                                                                                                                                                                                                                                                                                  
	 * 			String fileNameAtom: nombre del fichero para el formato ATOM                                                                                                                                                                                                                                                                                                
	 * @return void                                                                                                                                                                                                                                                                                                                                                                     
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private void crearXMLnoticias (NoticiaTraducidaVO[] noticias, String titulo, String link, String descripcion, String fileNameRss, String fileNameAtom,String idioma) throws Exception {                                                                                                                                                                                                               
    	                                                                                                                                                                                                                                                                                                                                                                                    
        try{                                                                                                                                                                                                                                                                                                                                                                                
			log("SrvAgregadorRssServiceImpl - crearXMLnoticias: comienza a crear el feed... " + titulo);                                                                                                                                                                                                                                                                  
        	feed.setLink("http://"+ feedHost + formatearMensaje(link, new String[]{feedHost}));                                                                                                                                                                                                                                                                                         
	        feed.setDescription(descripcion);                                                                                                                                                                                                                                                                                                                                           
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	        List entries = new ArrayList();                                                                                                                                                                                                                                                                                                                                             
	        SyndEntry entry;                                                                                                                                                                                                                                                                                                                                                            
//	        SyndContent description;                                                                                                                                                                                                                                                                                                                                                    
	        SyndContent imagenItem;                                                                                                                                                                                                                                                                                                                                                     
	        NoticiaTraducidaVO noticia;                                                                                                                                                                                                                                                                                                                                                 
	                                                                                                                                                                                                                                                                                                                                                                                    
	        for (int i=0; i<noticias.length;i++){                                                                                                                                                                                                                                                                                                                                       
	        	noticia = noticias[i];                                                                                                                                                                                                                                                                                                                                              
	            entry = new SyndEntryImpl();                                                                                                                                                                                                                                                                                                                                            
	            entry.setTitle(noticia.getTitulo());                                                                                                                                                                                                                                                                                                                                    
	            entry.setLink(formarURLnoticias()+noticia.getIdNoticia());                                                                                                                                                                                                                                                                                                              
	            entry.setPublishedDate(noticia.getFechaPublicacion().getTime());                                                                                                                                                                                                                                                                                                        
	            entry.setUpdatedDate(noticia.getFechaPublicacion().getTime());                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                            
	            imagenItem = new SyndContentImpl();                                                                                                                                                                                                                                                                                                                                     
	            imagenItem.setType("html");                                                                                                                                                                                                                                                                                                                                             
	            imagenItem.setMode("escaped");                                                                                                                                                                                                                                                                                                                                          
	                                                                                                                                                                                                                                                                                                                                                                                    
	            if (noticia.getURLImagen()!=null && !noticia.getURLImagen().equals("") && !noticia.getURLImagen().equals("http://localhost")){                                                                                                                                                                                                                                          
	            	String url=http + feedHost + noticia.getURLImagen();                                                                                                                                                                                                                                                                                                                
	            	try{                                                                                                                                                                                                                                                                                                                                                                
	            	URL urlImagen= new URL(url.substring(0,url.lastIndexOf("/")+1)+codificarURL(url.substring(url.lastIndexOf("/")+1)));                                                                                                                                                                                                                                                
	            	BufferedImage image = ImageIO.read(urlImagen);                                                                                                                                                                                                                                                                                                                      
		            int w = image.getWidth(); //if you want...                                                                                                                                                                                                                                                                                                                      
		            int h = image.getHeight();//if you want...                                                                                                                                                                                                                                                                                                                      
		            if (w<300 && h<300){                                                                                                                                                                                                                                                                                                                                            
		            	// imagen en su tamaño                                                                                                                                                                                                                                                                                                                                      
		            	imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + noticia.getURLImagen() + "'target='_blank'><img src='" + http + feedHost + noticia.getURLImagen() +"' width='" + w + "' height='" + h + "'/></a></p>" + noticia.getResumen());                                                                                                      
		            }else if (w>h){ //imagen horizontal                                                                                                                                                                                                                                                                                                                             
		            		int ancho=300;                                                                                                                                                                                                                                                                                                                                      
		            		int altura=(ancho*h)/w;                                                                                                                                                                                                                                                                                                                             
		            		imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + noticia.getURLImagen() + "'target='_blank'><img src='" + http + feedHost + noticia.getURLImagen() +"' width='" + ancho + "' height='" + altura + "'/></a></p>" + noticia.getResumen());                                                                                     
		            	}else if (h>w){ //imagen vertical                                                                                                                                                                                                                                                                                                                           
		            		int altura=300;                                                                                                                                                                                                                                                                                                                                     
		            		int ancho=(altura*w)/h;                                                                                                                                                                                                                                                                                                                             
		            		imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + noticia.getURLImagen() + "'target='_blank'><img src='" + http + feedHost + noticia.getURLImagen() +"' width='" + ancho + "' height='" + altura + "'/></a></p>" + noticia.getResumen());                                                                                     
		            	}else if (h==w){ // imagen cuadrada                                                                                                                                                                                                                                                                                                                         
		            		int ancho=250;                                                                                                                                                                                                                                                                                                                                      
		            		int altura=ancho;                                                                                                                                                                                                                                                                                                                                   
		            		imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + noticia.getURLImagen() + "'target='_blank'><img src='" + http + feedHost + noticia.getURLImagen() +"' width='" + ancho + "' height='" + altura + "'/></a></p>" + noticia.getResumen());                                                                                     
		            	}                                                                                                                                                                                                                                                                                                                                                           
	            	}catch(Exception e){                                                                                                                                                                                                                                                                                                                                                
	            		logger.error("Error al buscar la imagen", e);                                                                                                                                                                                                                                                                                                                  
	            	}                                                                                                                                                                                                                                                                                                                                                                   
	            }else{                                                                                                                                                                                                                                                                                                                                                                  
	            	imagenItem.setValue(noticia.getResumen());                                                                                                                                                                                                                                                                                                                          
	            }                                                                                                                                                                                                                                                                                                                                                                       
	            List contenido = new ArrayList();                                                                                                                                                                                                                                                                                                                                       
	            contenido.add(imagenItem);                                                                                                                                                                                                                                                                                                                                              
	            entry.setContents(contenido);                                                                                                                                                                                                                                                                                                                                           
	                                                                                                                                                                                                                                                                                                                                                                                    
	            entries.add(entry);                                                                                                                                                                                                                                                                                                                                                     
	        }                                                                                                                                                                                                                                                                                                                                                                           
	                                                                                                                                                                                                                                                                                                                                                                                    
	        SyndImageImpl image = new SyndImageImpl();                                                                                                                                                                                                                                                                                                                                  
	        image.setUrl(http + feedHost + "/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                                                          
            image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                                                                 
            image.setTitle("");                                                                                                                                                                                                                                                                                                                                                             
	                                                                                                                                                                                                                                                                                                                                                                                    
	        //Escribimos en el fichero                                                                                                                                                                                                                                                                                                                                                  
	        feed.setEntries(entries);
	        feed.setAuthor("Agrega");
	        feed.setPublishedDate(new Date());
	        //RSS                                                                                                                                                                                                                                                                                                                                                                       
	    	feed.setTitle(traduceEtiqueta(titulo + "_rss",idioma));                                                                                                                                                                                                                                                                                                                  
            feed.setFeedType(getPropertyValue("feedTypeRSS"));                                                                                                                                                                                                                                                                                                                              
            feed.setImage(image);                                                                                                                                                                                                                                                                                                                                                           
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando: " + feedPath + fileNameRss);                                                                                                                                                                                                                                                                          
	        Writer writer = new FileWriter(feedPath + fileNameRss);                                                                                                                                                                                                                                                                                                                     
	        SyndFeedOutput output = new SyndFeedOutput();                                                                                                                                                                                                                                                                                                                               
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
			log("SrvAgregadorRssServiceImpl - crearXMLnoticias: generando correctamente feed RSS: " + titulo);                                                                                                                                                                                                                                                            
	        //RSS                                                                                                                                                                                                                                                                                                                                                                       
	    	feed.setTitle(traduceEtiqueta(titulo + "_atom",idioma));                                                                                                                                                                                                                                                                                                                 
            feed.setFeedType(getPropertyValue("feedTypeAtom"));                                                                                                                                                                                                                                                                                                                             
	        log("SrvAgregadorRssServiceImpl - crearXMLauditoria: generando: " + feedPath + fileNameAtom);                                                                                                                                                                                                                                                                         
	        writer = new FileWriter(feedPath + fileNameAtom);                                                                                                                                                                                                                                                                                                                           
	        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                                 
	        writer.close();                                                                                                                                                                                                                                                                                                                                                             
			log("SrvAgregadorRssServiceImpl - crearXMLnoticias: generando correctamente feed ATOM: " + titulo);                                                                                                                                                                                                                                                           
        }catch (Exception e){                                                                                                                                                                                                                                                                                                                                                               
        	logger.error("[CREARXMLnoticias] Se ha producido un error al crear el fichero: " + titulo + "--> ", e);                                                                                                                                                                                                                                                                        
        }                                                                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Elimina los caracteres que puedan ser problematicos a la hora de formar la URL                                                                                                                                                                                                                                                                                                   
	 * @return String con la url                                                                                                                                                                                                                                                                                                                                                        
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private String formarURLodes ()throws Exception {                                                                                                                                                                                                                                                                                                                                       
    	return "http://"+ feedHost + "/ODE";                                                                                                                                                                                                                                                                                                                                                
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Forma la parte común de la url para poder visualizar el ODE.                                                                                                                                                                                                                                                                                                                     
	 * @param  String url: Url a codificar                                                                                                                                                                                                                                                                                                                                              
	 * @return String con la url                                                                                                                                                                                                                                                                                                                                                        
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private String codificarURL (String url) {                                                                                                                                                                                                                                                                                                                                              
    	url=url.replaceAll("%", "%25");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("\\$", "%26");                                                                                                                                                                                                                                                                                                                                                   
    	url=url.replaceAll(";", "%3B");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("\\?", "%3F");                                                                                                                                                                                                                                                                                                                                                   
    	url=url.replaceAll("/", "%2F");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll(":", "%3A");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("#", "%23");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("&", "%24");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("=", "%3D");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("\\+", "%2B");                                                                                                                                                                                                                                                                                                                                                   
    	url=url.replaceAll(",", "%2C");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll(" ", "%20");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("<", "%3C");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll(">", "%3E");                                                                                                                                                                                                                                                                                                                                                     
    	url=url.replaceAll("~", "%7E");                                                                                                                                                                                                                                                                                                                                                     
    	return url;                                                                                                                                                                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Forma la parte común del nombre fichero para poder visualizar el ODE.                                                                                                                                                                                                                                                                                                            
	 * @param  String nombreFichero: nombreFichero a codificar                                                                                                                                                                                                                                                                                                                          
	 * @return String con el nombreFichero                                                                                                                                                                                                                                                                                                                                              
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private String codificarNombreFichero (String nombreFichero) {                                                                                                                                                                                                                                                                                                                          
    	nombreFichero=nombreFichero.replaceAll("\\?", "%3F");                                                                                                                                                                                                                                                                                                                               
    	nombreFichero=nombreFichero.replaceAll("/", "%2F");                                                                                                                                                                                                                                                                                                                                 
    	nombreFichero=nombreFichero.replaceAll(":", "%3A");                                                                                                                                                                                                                                                                                                                                 
    	nombreFichero=nombreFichero.replaceAll("<", "%3C");                                                                                                                                                                                                                                                                                                                                 
    	nombreFichero=nombreFichero.replaceAll(">", "%3E");                                                                                                                                                                                                                                                                                                                                 
    	nombreFichero=nombreFichero.replaceAll("\\*", "%8E");                                                                                                                                                                                                                                                                                                                               
    	nombreFichero=nombreFichero.replaceAll("\\|", "%7C");                                                                                                                                                                                                                                                                                                                               
    	nombreFichero=nombreFichero.replaceAll("\"", "%22");                                                                                                                                                                                                                                                                                                                                
    	nombreFichero=nombreFichero.replaceAll("\\.", "%2E");                                                                                                                                                                                                                                                                                                                               
    	nombreFichero=nombreFichero.replaceAll("\\\\", "%5C");                                                                                                                                                                                                                                                                                                                              
    	nombreFichero=nombreFichero.replaceAll(" ", "20%");                                                                                                                                                                                                                                                                                                                                 
    	return nombreFichero;                                                                                                                                                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Forma la parte común de la url para poder visualizar la noticia.                                                                                                                                                                                                                                                                                                                 
	 * @return String con la url                                                                                                                                                                                                                                                                                                                                                        
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private String formarURLnoticias ()throws Exception {                                                                                                                                                                                                                                                                                                                                   
    	return "http://"+ feedHost + "/visualizadorcontenidos/Portada/NoticiasVer.do?id=";                                                                                                                                                                                                                                                                                                  
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Obtiene el valor almacenado en el fichero properties auditoria de una determinada cadena                                                                                                                                                                                                                                                                                         
	 * @param  sKey cadena de la que se quiere obtener el valor                                                                                                                                                                                                                                                                                                                         
	 * @return String                                                                                                                                                                                                                                                                                                                                                                   
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	private String getPropertyValue(String sKey) throws IOException                                                                                                                                                                                                                                                                                                                     
	{                                                                                                                                                                                                                                                                                                                                                                                   
		InputStream fIsSpringProperties = this.getClass().getResourceAsStream("/agregadorRSS.properties");                                                                                                                                                                                                                                                                          
		if (this.pAgregadorRSSProperties == null)                                                                                                                                                                                                                                                                                                                                   
		{                                                                                                                                                                                                                                                                                                                                                                           
			pAgregadorRSSProperties = new java.util.Properties();                                                                                                                                                                                                                                                                                                               
			pAgregadorRSSProperties.load(fIsSpringProperties);                                                                                                                                                                                                                                                                                                                  
		}                                                                                                                                                                                                                                                                                                                                                                           
		fIsSpringProperties.close();                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                            
		// devolvemos la propiedad                                                                                                                                                                                                                                                                                                                                                  
		return pAgregadorRSSProperties.getProperty(sKey);                                                                                                                                                                                                                                                                                                                           
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Recoge el fichero de recursos que se requiere                                                                                                                                                                                                                                                                                                                                    
	 *                                                                                                                                                                                                                                                                                                                                                                                  
	 * @param locale                                                                                                                                                                                                                                                                                                                                                                    
	 *                locale                                                                                                                                                                                                                                                                                                                                                            
	 * @return ficheroRecursos ResourcesBundle que contiene el fichero de                                                                                                                                                                                                                                                                                                               
	 *         recursos                                                                                                                                                                                                                                                                                                                                                                 
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	private ResourceBundle getFicherRecursos(Locale locale)                                                                                                                                                                                                                                                                                                                             
	{                                                                                                                                                                                                                                                                                                                                                                                   
		ResourceBundle ficheroRecursos = null;                                                                                                                                                                                                                                                                                                                                      
		ficheroRecursos = ResourceBundle.getBundle("application-resources", locale);                                                                                                                                                                                                                                                                                                
		return ficheroRecursos;                                                                                                                                                                                                                                                                                                                                                     
	}                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
	                                                                                                                                                                                                                                                                                                                                                                                    
	public static String formatearMensaje(String message,String [] args)                                                                                                                                                                                                                                                                                                                
	{                                                                                                                                                                                                                                                                                                                                                                                   
        	MessageFormat formatter = new MessageFormat("");                                                                                                                                                                                                                                                                                                                            
             if (args!=null && args.length>0)                                                                                                                                                                                                                                                                                                                                               
            {                                                                                                                                                                                                                                                                                                                                                                               
            		formatter.applyPattern(message);                                                                                                                                                                                                                                                                                                                                    
                    message = formatter.format(((Object) (args)));                                                                                                                                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                                                                                                                                               
        return message;                                                                                                                                                                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Devuelve la información relativa a los feeds relacionados con los ODEs                                                                                                                                                                                                                                                                                                           
	 *                                                                                                                                                                                                                                                                                                                                                                                  
	 * @return feedVO FeedsVO[] que contiene la información de los feeds                                                                                                                                                                                                                                                                                                                
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	protected es.pode.agregador.negocio.agregador.servicio.FeedVO[] handleDevuelveFeeds() throws Exception {                                                                                                                                                                                                                                                                            
		log("SrvAgregadorRssServiceImpl - devuelveFeeds: recuperando los datos de los feeds... ");                                                                                                                                                                                                                                                                            
		FeedVO[] feedsVO = new FeedVO[11];                                                                                                                                                                                                                                                                                                                                          
    	String idioma = I18n.getInstance().obtenerIdiomaDefectoPlataforma();                                                                                                                                                                                                                                                                                                                
    	ResourceBundle ficheroRecursos = this.getFicherRecursos(new Locale(idioma));                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                            
    	feedsVO[0] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[0].setTitulo(getPropertyValue("noticias.title"));                                                                                                                                                                                                                                                                                                                           
    	feedsVO[0].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[0].setUrl(feedHost + getPropertyValue("noticias.url"));                                                                                                                                                                                                                                                                                                        
    	feedsVO[0].setPath(feedHost + rss + "/" + getPropertyValue("noticias.fileName"));
    	feedsVO[0].setPeriodicidad("no");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[0].setId("0");                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                            
    	feedsVO[1] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[1].setTitulo(getPropertyValue("ultimosOdes.title"));                                                                                                                                                                                                                                                                                                                        
    	feedsVO[1].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[1].setUrl(feedHost + getPropertyValue("ultimosOdes.url"));                                                                                                                                                                                                                                                                                                                  
    	feedsVO[1].setPath(feedHost + rss + "/" + getPropertyValue("ultimosOdes.fileName"));                                                                                                                                                                                                                                                                                                
    	feedsVO[1].setPeriodicidad("no");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[1].setId("1");                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                            
    	feedsVO[2] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[2].setTitulo(getPropertyValue("ultimosOdes_Federado.title"));                                                                                                                                                                                                                                                                                                               
    	feedsVO[2].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[2].setUrl(feedHost + getPropertyValue("ultimosOdes_Federado.url"));                                                                                                                                                                                                                                                                                                         
    	feedsVO[2].setPath(feedHost + rss + "/" + getPropertyValue("ultimosOdes_Federado.fileName"));                                                                                                                                                                                                                                                                                       
    	feedsVO[2].setPeriodicidad("no");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[2].setId("2");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[3] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[3].setTitulo(getPropertyValue("masDescargados.title"));                                                                                                                                                                                                                                                                                                                     
    	feedsVO[3].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[3].setUrl(feedHost + getPropertyValue("masDescargados.url"));                                                                                                                                                                                                                                                                                                               
    	feedsVO[3].setPath(feedHost + rss + "/" + getPropertyValue("masDescargados.fileName"));                                                                                                                                                                                                                                                                                             
    	feedsVO[3].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[3].setId("3");                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                            
    	feedsVO[4] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[4].setTitulo(getPropertyValue("masDescargados_Federado.title"));                                                                                                                                                                                                                                                                                                            
    	feedsVO[4].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[4].setUrl(feedHost + getPropertyValue("masDescargados_Federado.url"));                                                                                                                                                                                                                                                                                                      
    	feedsVO[4].setPath(feedHost + rss + "/" + getPropertyValue("masDescargados_Federado.fileName"));                                                                                                                                                                                                                                                                                    
    	feedsVO[4].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[4].setId("4");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[5] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[5].setTitulo(getPropertyValue("masMostrados.title"));                                                                                                                                                                                                                                                                                                                       
    	feedsVO[5].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[5].setUrl(feedHost + getPropertyValue("masMostrados.url"));                                                                                                                                                                                                                                                                                                                 
    	feedsVO[5].setPath(feedHost + rss + "/" + getPropertyValue("masMostrados.fileName"));                                                                                                                                                                                                                                                                                               
    	feedsVO[5].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[5].setId("5");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[6] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[6].setTitulo(getPropertyValue("masMostrados_Federado.title"));                                                                                                                                                                                                                                                                                                              
    	feedsVO[6].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[6].setUrl(feedHost + getPropertyValue("masMostrados_Federado.url"));                                                                                                                                                                                                                                                                                                        
    	feedsVO[6].setPath(feedHost + rss + "/" + getPropertyValue("masMostrados_Federado.fileName"));                                                                                                                                                                                                                                                                                      
    	feedsVO[6].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[6].setId("6");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[7] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[7].setTitulo(getPropertyValue("masPrevisualizados.title"));                                                                                                                                                                                                                                                                                                                 
    	feedsVO[7].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[7].setUrl(feedHost + getPropertyValue("masPrevisualizados.url"));                                                                                                                                                                                                                                                                                                           
    	feedsVO[7].setPath(feedHost + rss + "/" + getPropertyValue("masPrevisualizados.fileName"));                                                                                                                                                                                                                                                                                         
    	feedsVO[7].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[7].setId("7");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[8] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[8].setTitulo(getPropertyValue("masPrevisualizados_Federado.title"));                                                                                                                                                                                                                                                                                                        
    	feedsVO[8].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[8].setUrl(feedHost + getPropertyValue("masPrevisualizados_Federado.url"));                                                                                                                                                                                                                                                                                                  
    	feedsVO[8].setPath(feedHost + rss + "/" + getPropertyValue("masPrevisualizados_Federado.fileName"));                                                                                                                                                                                                                                                                                
    	feedsVO[8].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[8].setId("8");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[9] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                          
    	feedsVO[9].setTitulo(getPropertyValue("masEnviados.title"));                                                                                                                                                                                                                                                                                                                        
    	feedsVO[9].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                      
    	feedsVO[9].setUrl(feedHost + getPropertyValue("masEnviados.url"));                                                                                                                                                                                                                                                                                                                  
    	feedsVO[9].setPath(feedHost + rss + "/" + getPropertyValue("masEnviados.fileName"));                                                                                                                                                                                                                                                                                                
    	feedsVO[9].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                   
    	feedsVO[9].setId("9");                                                                                                                                                                                                                                                                                                                                                              
    	                                                                                                                                                                                                                                                                                                                                                                                    
    	feedsVO[10] = new FeedVO();                                                                                                                                                                                                                                                                                                                                                         
    	feedsVO[10].setTitulo(getPropertyValue("masEnviados_Federado.title"));                                                                                                                                                                                                                                                                                                              
    	feedsVO[10].setDescripcion("");                                                                                                                                                                                                                                                                                                                                                     
    	feedsVO[10].setUrl(feedHost + getPropertyValue("masEnviados_Federado.url"));                                                                                                                                                                                                                                                                                                        
    	feedsVO[10].setPath(feedHost + rss + "/" + getPropertyValue("masEnviados_Federado.fileName"));                                                                                                                                                                                                                                                                                      
    	feedsVO[10].setPeriodicidad("si");                                                                                                                                                                                                                                                                                                                                                  
    	feedsVO[10].setId("10");                                                                                                                                                                                                                                                                                                                                                            
    	                                                                                                                                                                                                                                                                                                                                                                                    
		log("SrvAgregadorRssServiceImpl - devuelveFeeds: se han recuperado los datos de los feeds correctamente... ");                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            
		return feedsVO;                                                                                                                                                                                                                                                                                                                                                             
		                                                                                                                                                                                                                                                                                                                                                                            
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Este metodo recibe un parametro con los datos necesarios para realizar la busqueda                                                                                                                                                                                                                                                                                               
	 * Devuelve un DataHandler con los resultados de la búsqueda.                                                                                                                                                                                                                                                                                                                       
	 *                                                                                                                                                                                                                                                                                                                                                                                  
	 * @param ParametrosBusquedaAgregadorVO parametrosBusqueda: Parametro con los datos para realizar la busqueda.                                                                                                                                                                                                                                                                      
	 * @return DataHandler: Parametro que contiene la informacion recogida del fichero .xml generado tras realizar la busqueda                                                                                                                                                                                                                                                          
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	                                                                                                                                                                                                                                                                                                                                                                                    
	protected DataHandler handleDevuelveRssBusqueda(ParametrosBusquedaAgregadorVO parametrosBusqueda) throws Exception {                                                                                                                                                                                                                                                                
		                                                                                                                                                                                                                                                                                                                                                                            
//		a mi me llega un VO desde el buscador		                                                                                                                                                                                                                                                                                                                            
		DataHandler dh = null;                                                                                                                                                                                                                                                                                                                                                      
		String tituloFichero ="";                                                                                                                                                                                                                                                                                                                                                   
		String tituloFicheroCodificado ="";                                                                                                                                                                                                                                                                                                                                                   
		String nombreFichero = "";                                                                                                                                                                                                                                                                                                                                                  
		                                                                                                                                                                                                                                                                                                                                                                            
		String dia= "";                                                                                                                                                                                                                                                                                                                                                             
		String mes= "";                                                                                                                                                                                                                                                                                                                                                             
		String año= "";                                                                                                                                                                                                                                                                                                                                                             
		String urlBusqueda = "/buscador/BuscarAvanzadoCU/MostrarFormularioAvanzadoAnalizaPulsacion.do?"+                                                                                                                                                                                                                                                                            
							"buscadorContenido="+parametrosBusqueda.getPalabrasClave()+"&idioma="+parametrosBusqueda.getIdiomaBusqueda()+                                                                                                                                                                                                                       
							"&formato="+parametrosBusqueda.getFormato()+"&recurso="+parametrosBusqueda.getRecurso()+"&procesoCognitivo="+                                                                                                                                                                                                                       
							parametrosBusqueda.getProcesoCognitivo()+"&contexto="+parametrosBusqueda.getContexto()+"&edad="+                                                                                                                                                                                                                                    
							parametrosBusqueda.getEdad()+"&autor="+parametrosBusqueda.getAutor()+                                                                                                                                                                                                                                                               
							"&diaPublicacion="+ dia +
							"&mesPublicacion="+mes+
							"&anyoPublicacion="+año+
							"&c_s_secuencia="+((parametrosBusqueda.getSecuencia()!=null)?parametrosBusqueda.getSecuencia():"")+ "&valoracion="+                                                                                                                                                                                                                 
							parametrosBusqueda.getValoracion().replaceAll("-", " ")+"&areaCurricular="+((parametrosBusqueda.getAreaCurricular()!=null)?parametrosBusqueda.getAreaCurricular():"")+                                                                                                                                                              
							"&enlaceComunidadesSeleccionadas="+((parametrosBusqueda.getTipoBusqueda()!=null && parametrosBusqueda.getTipoBusqueda().equals("01"))?parametrosBusqueda.getComunidadesSeleccionadas():"")                                                                                                                                          
							+"&idTesauro="+parametrosBusqueda.getIdTesauro()+                                                                                                                                                                                                                                                                                   
							"&nivelAgregacion="+parametrosBusqueda.getNivelAgregacion()+"&destinatarios="+                                                                                                                                                                                                                                                      
							parametrosBusqueda.getDestinatarios()+"&keyword="+parametrosBusqueda.getKeyword()+"&tipoBusqueda="+                                                                                                                                                                                                                                 
							parametrosBusqueda.getTipoBusqueda();                                                                                                                                                                                                                                                                                               
//		mapeo el VO que recibo a ParametrosBusquedaAvanzadaVO para llamar al buscador                                                                                                                                                                                                                                                                                               
		ParametrosBusquedaAvanzadaVO paramBusq = mapearParametrosBusqueda(parametrosBusqueda);                                                                                                                                                                                                                                                                                      
		ValoresBusquedaVO[] valoresBusqueda=null;                                                                                                                                                                                                                                                                                                                                   
		                                                                                                                                                                                                                                                                                                                                                                            
		try{                                                                                                                                                                                                                                                                                                                                                                        
			ResultadoBusquedaVO resultadosBusqueda = this.getSrvBuscarService().buscarAvanzado(paramBusq);                                                                                                                                                                                                                                                                      
			valoresBusqueda = new ValoresBusquedaVO[resultadosBusqueda.getResultadoBusqueda().length];                                                                                                                                                                                                                                                                          
			valoresBusqueda = resultadosBusqueda.getResultadoBusqueda();                                                                                                                                                                                                                                                                                                        
			log("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Se han encontrado "+valoresBusqueda.length + " resultados");                                                                                                                                                                                                                                           
		}catch (Exception e){                                                                                                                                                                                                                                                                                                                                                       
			logger.error("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Error al realizar la busqueda", e);                                                                                                                                                                                                                                                                    
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
//		pongo nombre único al fichero que voy a generar                                                                                                                                                                                                                                                                                                                             
		try{                                                                                                                                                                                                                                                                                                                                                                        
			tituloFichero = this.getSrvBuscarService().generadorIdentificadorAvanzado(paramBusq);                                                                                                                                                                                                                                                                               
			tituloFicheroCodificado = codificarNombreFichero(tituloFichero);                                                                                                                                                                                                                                                                                                    
			log("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: El identificador para el fichero xml a generar es " + tituloFicheroCodificado);                                                                                                                                                                                                                        
		}catch (Exception e){                                                                                                                                                                                                                                                                                                                                                       
			logger.error("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Error al generar el nombre de fichero con identificador unico",e);                                                                                                                                                                                                                                     
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
//		creamos nombre, url y descripcion para el fichero                                                                                                                                                                                                                                                                                                                           
//		urlFichero = "/visualizadorcontenidos/ListarFeedsCU/ListarFeedsCU.do?fichero=" + tituloFicheroCodificado + "&periodicidad=no";                                                                                                                                                                                                                                              
		nombreFichero = tituloFicheroCodificado + "_rss.xml";                                                                                                                                                                                                                                                                                                                       
		                                                                                                                                                                                                                                                                                                                                                                            
		String rutaFichero=feedPathResultadosBusqueda+ tituloFicheroCodificado + "_rss.xml";                                                                                                                                                                                                                                                                                        
		File fichero = new File(rutaFichero);                                                                                                                                                                                                                                                                                                                                       
		                                                                                                                                                                                                                                                                                                                                                                            
		if (!fichero.exists()){                                                                                                                                                                                                                                                                                                            
	//		el buscar me devuelve unos resultados que yo meto en un .xml                                                                                                                                                                                                                                                                                                        
			try{                                                                                                                                                                                                                                                                                                                                                                
				crearXMLBusqueda(valoresBusqueda, tituloFicheroCodificado, urlBusqueda, obtenerDescripcionRSS (parametrosBusqueda),                                                                                                                                                                                                                                         
						nombreFichero,parametrosBusqueda.getIdiomaBusqueda(), parametrosBusqueda.getIdiomaNavegacion());                                                                                                                                                                                                                                                                                                                     
				log("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Se ha creado correctamente el xml con los resultados de lo busqueda");                                                                                                                                                                                                                         
			}catch (Exception e){                                                                                                                                                                                                                                                                                                                                               
				logger.error("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Se ha producido un error al generar el xml con los resultados de la busqueda",e);                                                                                                                                                                                                                
			}                                                                                                                                                                                                                                                                                                                                                                   
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
//		devuelvo ese .xml en un DataHandler para visualizarlo                                                                                                                                                                                                                                                                                                                       
		dh = new DataHandler(new FileDataSource(fichero));
		log("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: Devolvemos el xml en un DataHandler");                                                                                                                                                                                                                                                                         
		return dh;                                                                                                                                                                                                                                                                                                                                                                  
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String obtenerDescripcionRSS (ParametrosBusquedaAgregadorVO parametrosBusqueda){                                                                                                                                                                                                                                                                                            
		                                                                                                                                                                                                                                                                                                                                                                            
		String descripcion = "";                                                                                                                                                                                                                                                                                                                                                    
		try{                                                                                                                                                                                                                                                                                                                                                                        
			descripcion = traduceEtiqueta("textoResultadoBusqueda",parametrosBusqueda.getIdiomaNavegacion()) + " ";                                                                                                                                                                                                                                                                                                     
			descripcion = descripcion + parametrosBusqueda.getPalabrasClave() + " " +                                                                                                                                                                                                                                                                                           
			traduceEtiqueta("textoParametrosBusqueda",parametrosBusqueda.getIdiomaNavegacion()) + " "                                                                                                                                                                                                                                                                                                                  
			+ ((parametrosBusqueda.getIdiomaBusqueda()!=null && !parametrosBusqueda.getIdiomaBusqueda().equals(""))? traduceEtiqueta("idioma",parametrosBusqueda.getIdiomaNavegacion()) + ": " + I18n.getInstance().obtenerIdiomaTraducido(parametrosBusqueda.getIdiomaBusqueda(), parametrosBusqueda.getIdiomaNavegacion()):"")                                                                                                                                                                             
			+ ((parametrosBusqueda.getAreaCurricular()!=null && !parametrosBusqueda.getAreaCurricular().equals(""))? "; "+ traduceEtiqueta("areaCurricular",parametrosBusqueda.getIdiomaNavegacion()) + ": " + convertirStringAreaCurricular(parametrosBusqueda.getAreaCurricular(), parametrosBusqueda.getIdiomaNavegacion()):"")                                                                                        
			+ ((parametrosBusqueda.getNivelAgregacion()!=null && !parametrosBusqueda.getNivelAgregacion().equals(""))? "; "+ traduceEtiqueta("nivelAgregacion",parametrosBusqueda.getIdiomaNavegacion()) + ": " + nivelAgregacion( parametrosBusqueda.getNivelAgregacion(), parametrosBusqueda.getIdiomaNavegacion()):"")                                                                                                 
			+ ((parametrosBusqueda.getFormato()!=null && !parametrosBusqueda.getFormato().equals(""))? "; "+ traduceEtiqueta("tipoFormato",parametrosBusqueda.getIdiomaNavegacion()) + ": " + formato (parametrosBusqueda.getFormato(), parametrosBusqueda.getIdiomaNavegacion()):"")                                                                                                                                     
			+ ((parametrosBusqueda.getRecurso()!=null && !parametrosBusqueda.getRecurso().equals(""))? "; "+ traduceEtiqueta("recurso",parametrosBusqueda.getIdiomaNavegacion()) + ": " + traducirVocabulario (parametrosBusqueda.getRecurso(), BuscarController.getPropertyValue("recurso"), parametrosBusqueda.getIdiomaNavegacion()): "")                                                                              
			+ ((parametrosBusqueda.getProcesoCognitivo()!=null && !parametrosBusqueda.getProcesoCognitivo().equals(""))? ", "+ traduceEtiqueta("procesoCognitivo",parametrosBusqueda.getIdiomaNavegacion()) + ": " + traducirVocabulario (parametrosBusqueda.getProcesoCognitivo(), BuscarController.getPropertyValue("procesoCognitivo"), parametrosBusqueda.getIdiomaNavegacion()): "")                                 
			+ ((parametrosBusqueda.getContexto()!=null && !parametrosBusqueda.getContexto().equals(""))? "; "+ traduceEtiqueta("contexto",parametrosBusqueda.getIdiomaNavegacion()) + ": " + traducirVocabulario (parametrosBusqueda.getContexto(), BuscarController.getPropertyValue("contexto"), parametrosBusqueda.getIdiomaNavegacion()): "")                                                                         
			+ ((parametrosBusqueda.getEdad()!=null && !parametrosBusqueda.getEdad().equals(""))? "; "+ traduceEtiqueta("edad",parametrosBusqueda.getIdiomaNavegacion()) + ": " + parametrosBusqueda.getEdad():"")                                                                                                                                                                                                       
			+ ((parametrosBusqueda.getAutor()!=null && !parametrosBusqueda.getAutor().equals(""))? "; "+ traduceEtiqueta("autor",parametrosBusqueda.getIdiomaNavegacion()) + ": " + parametrosBusqueda.getAutor():"")                                                                                                                                                                                                   
			+ ((parametrosBusqueda.getFechaPublicacion()!=null && !parametrosBusqueda.getFechaPublicacion().equals(""))? "; "+ traduceEtiqueta("fechaPublicacion",parametrosBusqueda.getIdiomaNavegacion()) + ": " + formatoFecha (parametrosBusqueda.getFechaPublicacion(), "", "", ""):"")                                                                                                                            
			+ ((parametrosBusqueda.getSecuencia()!=null && !parametrosBusqueda.getSecuencia().equals(""))? "; "+ traduceEtiqueta("secuenciacion",parametrosBusqueda.getIdiomaNavegacion()) + ": " + secuenciacion (parametrosBusqueda.getSecuencia(), parametrosBusqueda.getIdiomaNavegacion()):"")                                                                                                                       
			+ ((parametrosBusqueda.getValoracion()!=null && !parametrosBusqueda.getValoracion().equals(""))? "; "+ traduceEtiqueta("valoracion",parametrosBusqueda.getIdiomaNavegacion()) + ": " + parametrosBusqueda.getValoracion():"")                                                                                                                                                                               
			+ ((parametrosBusqueda.getDestinatarios()!=null && !parametrosBusqueda.getDestinatarios().equals(""))? "; "+ traduceEtiqueta("destinatarios",parametrosBusqueda.getIdiomaNavegacion()) + ": " + traducirVocabulario (parametrosBusqueda.getDestinatarios(), BuscarController.getPropertyValue("destinatarios"), parametrosBusqueda.getIdiomaNavegacion()): "")                                                
			+ ((parametrosBusqueda.getIdTesauro()!=null && !parametrosBusqueda.getIdTesauro().equals(""))? "; "+ traduceEtiqueta("tesauro",parametrosBusqueda.getIdiomaNavegacion()) + ": " + this.getSrvTesaurosServices().obtenerTextosDeIds(new String[]{parametrosBusqueda.getIdTesauro()}, parametrosBusqueda.getIdiomaNavegacion(), this.getPropertyValue("nombreFichTesauros"))[0].getValorTax():"")               
			+ ((parametrosBusqueda.getComunidadesSeleccionadas()!=null && parametrosBusqueda.getComunidadesSeleccionadas().length>0)? "; "+ traduceEtiqueta("comunidadesSeleccionadas",parametrosBusqueda.getIdiomaNavegacion()) + ": " + obtenerComunidades(parametrosBusqueda.getComunidadesSeleccionadas(),parametrosBusqueda.getIdiomaNavegacion()):"");                                                       
		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                                      
			logger.error("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: error al recuperar la descripción del fichero",e);                                                                                                                                                                                                                                                       
		}                                                                                                                                                                                                                                                                                                                                                                           
		log("Descripcion del RSS="+descripcion);
		return descripcion;                                                                                                                                                                                                                                                                                                                                                         
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String secuenciacion (Boolean secuencia, String idioma){                                                                                                                                                                                                                                                                                                                    
		if (secuencia)                                                                                                                                                                                                                                                                                                                                                              
			return TraduccionesBuscador.getInstance().traduceEtiqueta("configurar.avanzado.c_s_secuencia.texto.conSecuencia", idioma);                                                                                                                                                                                                                                          
		else                                                                                                                                                                                                                                                                                                                                                                        
			return TraduccionesBuscador.getInstance().traduceEtiqueta("configurar.avanzado.c_s_secuencia.texto.sinSecuencia", idioma);                                                                                                                                                                                                                                          
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String traducirVocabulario (String termino, String idVocabulario, String idioma){                                                                                                                                                                                                                                                                                           
		try {                                                                                                                                                                                                                                                                                                                                                                       
		                                                                                                                                                                                                                                                                                                                                                                            
		TerminoYPadreVO[] terminoypadre = new TerminoYPadreVO[1];                                                                                                                                                                                                                                                                                                                   
		terminoypadre[0]= new TerminoYPadreVO();                                                                                                                                                                                                                                                                                                                                    
		terminoypadre[0].setIdiomaTermino(BuscarController.getPropertyValue("idioma.terminos"));                                                                                                                                                                                                                                                                                    
		terminoypadre[0].setNomTermino(termino);                                                                                                                                                                                                                                                                                                                                    
		terminoypadre[0].setIdVocabulario(idVocabulario);                                                                                                                                                                                                                                                                                                                           
		terminoypadre[0].setIdTermino("");                                                                                                                                                                                                                                                                                                                                          
		terminoypadre = this.getSrvVocabulariosControladosService().obtenerIdTermino(terminoypadre);                                                                                                                                                                                                                                                                                
		return this.getSrvVocabulariosControladosService().crearTraduccionAIdioma(new String[]{terminoypadre[0].getIdTermino()}, idioma)[0].getNomTermino();                                                                                                                                                                                                                        
		} catch (Exception e){                                                                                                                                                                                                                                                                                                                                                      
			logger.error("SrvAgregadorRssServiceImpl - devuelveRssBusqueda: error al recuperar la descripción del fichero");                                                                                                                                                                                                                                                       
			return "";                                                                                                                                                                                                                                                                                                                                                          
		}                                                                                                                                                                                                                                                                                                                                                                           
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String formatoFecha (String fecha, String dia, String mes, String año){                                                                                                                                                                                                                                                                                                     
		log("SrvAgregadorRssServiceImpl - entra en formatoFecha");                                                                                                                                                                                                                                                                                                         
		String resultado = "";                                                                                                                                                                                                                                                                                                                                                      
		if (fecha == null || fecha.length()<=0 || fecha.equals("***"))                                                                                                                                                                                                                                                                                                              
			return resultado;                                                                                                                                                                                                                                                                                                                                                   
		if (fecha.charAt(0)=='*'){                                                                                                                                                                                                                                                                                                                                                  
			//no tiene año                                                                                                                                                                                                                                                                                                                                                      
			fecha = fecha.substring(1, fecha.length());                                                                                                                                                                                                                                                                                                                         
			resultado = "*";                                                                                                                                                                                                                                                                                                                                                    
			año="";                                                                                                                                                                                                                                                                                                                                                             
		} else {                                                                                                                                                                                                                                                                                                                                                                    
			año = fecha.substring(0, 4);                                                                                                                                                                                                                                                                                                                                        
			resultado = año;                                                                                                                                                                                                                                                                                                                                                    
			fecha = fecha.substring(4, fecha.length());                                                                                                                                                                                                                                                                                                                         
		}                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
		if (fecha.charAt(0)=='*'){                                                                                                                                                                                                                                                                                                                                                  
			//no tiene mes                                                                                                                                                                                                                                                                                                                                                      
			fecha = fecha.substring(1, fecha.length());                                                                                                                                                                                                                                                                                                                         
			resultado = "*/" + resultado;                                                                                                                                                                                                                                                                                                                                       
			mes = "";                                                                                                                                                                                                                                                                                                                                                           
		} else {                                                                                                                                                                                                                                                                                                                                                                    
			mes = fecha.substring(0, 2);                                                                                                                                                                                                                                                                                                                                        
			resultado = mes + "/" + resultado;                                                                                                                                                                                                                                                                                                                                  
			fecha = fecha.substring(2, fecha.length());                                                                                                                                                                                                                                                                                                                         
	}                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                            
		if (fecha.charAt(0)=='*'){                                                                                                                                                                                                                                                                                                                                                  
			//no tiene dia                                                                                                                                                                                                                                                                                                                                                      
			resultado = "*/" + resultado;                                                                                                                                                                                                                                                                                                                                       
			dia = "";                                                                                                                                                                                                                                                                                                                                                           
		} else {                                                                                                                                                                                                                                                                                                                                                                    
			dia = fecha.substring(0, 2);                                                                                                                                                                                                                                                                                                                                        
			resultado = dia + "/" + resultado;                                                                                                                                                                                                                                                                                                                                  
		}                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
		return resultado;                                                                                                                                                                                                                                                                                                                                                           
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String nivelAgregacion (String nivel, String idioma){                                                                                                                                                                                                                                                                                                                       
		log("SrvAgregadorRssServiceImpl - entra en nivelAgregación: " + nivel);                                                                                                                                                                                                                                                                                               
		return TraduccionesBuscador.getInstance().traduceEtiqueta(BuscarController.getPropertyValue("avanzado.agregacion." + nivel), idioma);                                                                                                                                                                                                                                  
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	private String formato (String formato, String idioma){                                                                                                                                                                                                                                                                                                                             
		log("SrvAgregadorRssServiceImpl - entra en formato: " + formato);                                                                                                                                                                                                                                                                                                     
			if (formato.equals("application/*")) return TraduccionesBuscador.getInstance().traduceEtiqueta("listar.odecu.mostrar.resultados.consulta.vo.aplicacion", idioma);                                                                                                                                                                                                   
			else if (formato.equals("image/*")) return TraduccionesBuscador.getInstance().traduceEtiqueta("listar.odecu.mostrar.resultados.consulta.vo.imagen", idioma);                                                                                                                                                                                                        
			else if (formato.equals("audio/*")) return TraduccionesBuscador.getInstance().traduceEtiqueta("listar.odecu.mostrar.resultados.consulta.vo.audio", idioma);                                                                                                                                                                                                         
			else if (formato.equals("text/*")) return TraduccionesBuscador.getInstance().traduceEtiqueta("listar.odecu.mostrar.resultados.consulta.vo.texto", idioma);                                                                                                                                                                                                          
			else if (formato.equals("video/*")) return TraduccionesBuscador.getInstance().traduceEtiqueta("listar.odecu.mostrar.resultados.consulta.vo.video", idioma);                                                                                                                                                                                                         
			else return "";                                                                                                                                                                                                                                                                                                                                                     
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
    private String obtenerComunidades(String[] comunidadesSeleccionadas,String idiomaNavegacion) throws RemoteException, Exception{		                                                                                                                                                                                                                                            
		log("SrvAgregadorRssServiceImpl - entra en obtenerComunidades: " + array2String(comunidadesSeleccionadas));                                                                                                                                                                                                                                                                         
		if (comunidadesSeleccionadas[0].equals("0")){                                                                                                                                                                                                                                                                                                                               
			return "busqueda federada";                                                                                                                                                                                                                                                                                                                                         
		}                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                            
		String resultado = "";                                                                                                                                                                                                                                                                                                                                                      
		for(int i=0; i < comunidadesSeleccionadas.length;i++){                                                                                                                                                                                                                                                                                                                      
			resultado = resultado + this.getSrvNodoService().obtenerNodo(new Long(comunidadesSeleccionadas[i])).getNodo();                                                                                                                                                                                                                                                      
			resultado = resultado + ", ";                                                                                                                                                                                                                                                                                                                                       
		}
		if(!resultado.trim().equals("")) resultado = resultado.substring(0, resultado.length()-2)+ " " +traduceEtiqueta("textoConcatenador",idiomaNavegacion) + " " +DependentServerProperties.getInstance().getServerOn();
		else resultado = resultado + DependentServerProperties.getInstance().getServerOn();                                                                                                                                                                                                                                                                                                                                  
		return resultado;                                                                                                                                                                                                                                                                                                                                                           
	}

    private void log(String textoDebug){	                                                                                                                                                                                                                                            
		if(logger.isDebugEnabled())logger.debug(textoDebug);
	}   
	                                                                                                                                                                                                                                                                                                                                                                                    
//  Este metodo recibe el identificador del nivel educativo que se ha elegido y                                                                                                                                                                                                                                                                                                             
//  extrae toda la ruta hasta el padre y la convierte a string con el texto ordenado                                                                                                                                                                                                                                                                                                        
//  desde el padre hasta el hijo traducido al idioma que se le diga.                                                                                                                                                                                                                                                                                                                        
  private String convertirStringAreaCurricular(String areaCurricular, String idioma) throws Exception{                                                                                                                                                                                                                                                                                      
		log("SrvAgregadorRssServiceImpl - entra en areaCurricular");                                                                                                                                                                                                                                                                                                          
	  List rutaPadrevo = Arrays.asList(this.getSrvTaxonomiaService().obtenerTaxonPath(areaCurricular, this.getPropertyValue("nombreAreaCurricularTax"), idioma));                                                                                                                                                                                                                       
	  Collections.reverse(rutaPadrevo);                                                                                                                                                                                                                                                                                                                                                 
	  TaxonVO[] taxVORutaPadre = (TaxonVO[])rutaPadrevo.toArray();                                                                                                                                                                                                                                                                                                                      
	  String rutaPadre[] = new String[taxVORutaPadre.length];                                                                                                                                                                                                                                                                                                                           
	  for (int i = 0; i < taxVORutaPadre.length; i++) rutaPadre[i]= taxVORutaPadre[i].getValorTax();                                                                                                                                                                                                                                                                                    
	  return array2String(rutaPadre);                                                                                                                                                                                                                                                                                                                                                   
  }                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                            
  private String array2String(String[] array) {                                                                                                                                                                                                                                                                                                                                             
		String str = "";                                                                                                                                                                                                                                                                                                                                                            
		if (array != null && array.length > 0) {                                                                                                                                                                                                                                                                                                                                    
			for (int i = 0; i < array.length; i++) {                                                                                                                                                                                                                                                                                                                            
				str+=array[i];                                                                                                                                                                                                                                                                                                                                              
				if ((i + 1) < array.length) str+= NIV_EDU_SEPARATOR;                                                                                                                                                                                                                                                                                                        
			}                                                                                                                                                                                                                                                                                                                                                                   
		}                                                                                                                                                                                                                                                                                                                                                                           
		return str;
	}
  
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Este metodo recibe un VO del Agregador para mapear a uno del Buscar                                                                                                                                                                                                                                                                                                              
	 * Devuelve el VO mapeado para poder llamar al servicio Buscar                                                                                                                                                                                                                                                                                                                      
	 *                                                                                                                                                                                                                                                                                                                                                                                  
	 * @param ParametrosBusquedaAgregadorVO parametrosBusqueda: Parametro con los datos para realizar la busqueda.                                                                                                                                                                                                                                                                      
	 * @return ParametrosBusquedaAvanzadaVO: Parametro mapeado con la misma informacion del que recibimos                                                                                                                                                                                                                                                                               
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	private ParametrosBusquedaAvanzadaVO mapearParametrosBusqueda (ParametrosBusquedaAgregadorVO parametrosBusqueda){                                                                                                                                                                                                                                                                   
		ParametrosBusquedaAvanzadaVO paramBusq = new ParametrosBusquedaAvanzadaVO();                                                                                                                                                                                                                                                                                                
		paramBusq.setArbolCurricularVigente(parametrosBusqueda.getArbolCurricularVigente());                                                                                                                                                                                                                                                                                        
		paramBusq.setAreaCurricular(parametrosBusqueda.getAreaCurricular());                                                                                                                                                                                                                                                                                                        
		paramBusq.setAutor(parametrosBusqueda.getAutor());                                                                                                                                                                                                                                                                                                                          
		paramBusq.setComunidadesSeleccionadas(parametrosBusqueda.getComunidadesSeleccionadas());                                                                                                                                                                                                                                                                                    
		paramBusq.setContexto(parametrosBusqueda.getContexto());                                                                                                                                                                                                                                                                                                                    
		paramBusq.setDescripcion(parametrosBusqueda.getDescripcion());                                                                                                                                                                                                                                                                                                              
		paramBusq.setDestinatarios(parametrosBusqueda.getDestinatarios());                                                                                                                                                                                                                                                                                                          
		paramBusq.setEdad(parametrosBusqueda.getEdad());                                                                                                                                                                                                                                                                                                                            
		paramBusq.setFechaPublicacion(parametrosBusqueda.getFechaPublicacion());                                                                                                                                                                                                                                                                                                    
		paramBusq.setFormato(parametrosBusqueda.getFormato());                                                                                                                                                                                                                                                                                                                      
		paramBusq.setIdBusqueda(parametrosBusqueda.getIdBusqueda());                                                                                                                                                                                                                                                                                                                
		paramBusq.setIdiomaBusqueda(parametrosBusqueda.getIdiomaBusqueda());                                                                                                                                                                                                                                                                                                        
		paramBusq.setIdiomaNavegacion(parametrosBusqueda.getIdiomaNavegacion());                                                                                                                                                                                                                                                                                                    
		paramBusq.setKeyword(parametrosBusqueda.getKeyword());                                                                                                                                                                                                                                                                                                                      
		paramBusq.setNivelAgregacion(parametrosBusqueda.getNivelAgregacion());                                                                                                                                                                                                                                                                                                      
		paramBusq.setNumeroResultados(parametrosBusqueda.getNumeroResultados());                                                                                                                                                                                                                                                                                                    
		paramBusq.setOrigenPagina(parametrosBusqueda.getOrigenPagina());                                                                                                                                                                                                                                                                                                            
		paramBusq.setPalabrasClave(parametrosBusqueda.getPalabrasClave());                                                                                                                                                                                                                                                                                                          
		paramBusq.setProcesoCognitivo(parametrosBusqueda.getProcesoCognitivo());                                                                                                                                                                                                                                                                                                    
		paramBusq.setRecurso(parametrosBusqueda.getRecurso());                                                                                                                                                                                                                                                                                                                      
		paramBusq.setResultadosPorPagina(parametrosBusqueda.getResultadosPorPagina());                                                                                                                                                                                                                                                                                              
		paramBusq.setSecuencia(parametrosBusqueda.getSecuencia());                                                                                                                                                                                                                                                                                                                  
		paramBusq.setTitulo(parametrosBusqueda.getTitulo());                                                                                                                                                                                                                                                                                                                        
		paramBusq.setValoracion(parametrosBusqueda.getValoracion().replaceAll("-", " "));                                                                                                                                                                                                                                                                                           
		paramBusq.setBusquedaSimpleAvanzada(parametrosBusqueda.getBusquedaSimpleAvanzada());                                                                                                                                                                                                                                                                                        
		paramBusq.setIdTesauro(parametrosBusqueda.getIdTesauro());                                                                                                                                                                                                                                                                                                                  
		paramBusq.setComunidadPeticion(parametrosBusqueda.getComunidadPeticion());                                                                                                                                                                                                                                                                                                  
				                                                                                                                                                                                                                                                                                                                                                            
		return paramBusq;                                                                                                                                                                                                                                                                                                                                                           
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                            
	private boolean esVisualizable (String[] ambito){                                                                                                                                                                                                                                                                                                                                   
		                                                                                                                                                                                                                                                                                                                                                                            
		boolean visualizable = false;                                                                                                                                                                                                                                                                                                                                               
		for (int j = 0; j < ambito.length && !visualizable; j++) {                                                                                                                                                                                                                                                                                                                  
			if(ambito!=null && ambito[0]!=null && (ambito[0].equals(UNIVERSAL) || ambito[j].trim().equals(DependentServerProperties.getInstance().getProperty(IDENTIFICADOR_NODO).toString()))){                                                                                                                                                                                
				visualizable=true;                                                                                                                                                                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                                                                                                                                   
		}                                                                                                                                                                                                                                                                                                                                                                           
		return visualizable;                                                                                                                                                                                                                                                                                                                                                        
	}                                                                                                                                                                                                                                                                                                                                                                                   
	                                                                                                                                                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                                                                                                                                                    
	/**                                                                                                                                                                                                                                                                                                                                                                                 
	 * Crea los xmls correspondientes a los informes de auditoría formato RSS y ATOM                                                                                                                                                                                                                                                                                                    
	 * @param  	ValoresBusquedaVO[] valoresBusqueda: array de odes que formarán el feed                                                                                                                                                                                                                                                                                             
	 * 			String titulo: titulo del feed                                                                                                                                                                                                                                                                                                                              
	 * 			String link: link del feed                                                                                                                                                                                                                                                                                                                                  
	 * 			String descripcion: descripción del feed                                                                                                                                                                                                                                                                                                                    
	 * 			String fileNameRss: nombre del fichero para el formato RSS                                                                                                                                                                                                                                                                                                  
	 * @return void                                                                                                                                                                                                                                                                                                                                                                     
	 * @throws Exception                                                                                                                                                                                                                                                                                                                                                                
	 */                                                                                                                                                                                                                                                                                                                                                                                 
    private void crearXMLBusqueda (ValoresBusquedaVO[] valoresBusqueda, String titulo, String link, String descripcion, String fileNameRss, String idioma,String idiomaNavegacion) throws Exception {                                                                                                                                                                                                               
    	                                                                                                                                                                                                                                                                                                                                                                                    
        try{                                                                                                                                                                                                                                                                                                                                                                                
        	feed.setEncoding("ISO-8859-1");                                                                                                                                                                                                                                                                                                                                             
			log("SrvAgregadorRssServiceImpl - crearXMLBusqueda: comienza a crear el feed de la busqueda realizada");                                                                                                                                                                                                                                                      
	        feed.setLink("http://" + feedHost + link);                                                                                                                                                                                                                                                                                                                                  
	        feed.setAuthor("Agrega");
	        feed.setPublishedDate(new Date());
	        List entries = new ArrayList();                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                            
	        SyndEntry entry;                                                                                                                                                                                                                                                                                                                                                            
	        SyndImageImpl image = new SyndImageImpl();                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                            
	        SyndContent imagenItem;                                                                                                                                                                                                                                                                                                                                                     
	                                                                                                                                                                                                                                                                                                                                                                                    
//	        DocVO docVO = null;                                                                                                                                                                                                                                                                                                                                                         
	        if (valoresBusqueda != null){                                                                                                                                                                                                                                                                                                                                               
		        for (int i=0; i<valoresBusqueda.length;i++){                                                                                                                                                                                                                                                                                                                        
		        	entry = new SyndEntryImpl();                                                                                                                                                                                                                                                                                                                                
		        	try{                                                                                                                                                                                                                                                                                                                                                        
		        		log("tenemos todos los datos necesarios del ODE");                                                                                                                                                                                                                                                                                            
		        		entry.setTitle(valoresBusqueda[i].getTitulo());                                                                                                                                                                                                                                                                                                     
		        		if (esVisualizable(valoresBusqueda[i].getAmbito())){                                                                                                                                                                                                                                                                                                
		        			if (valoresBusqueda[i].getNodo()!=null){                                                                                                                                                                                                                                                                                                    
		        				entry.setLink(http + valoresBusqueda[i].getNodo() + "/ODE" + "/" + idioma + "/" +valoresBusqueda[i].getId());                                                                                                                                                                                                                       
		        			}else{                                                                                                                                                                                                                                                                                                                                      
		        				entry.setLink(http + feedHost + "/ODE" + "/" + idioma + "/" +valoresBusqueda[i].getId());                                                                                                                                                                                                                                           
		        			}                                                                                                                                                                                                                                                                                                                                           
		        		}                                                                                                                                                                                                                                                                                                                                                   
		        		entry.setUpdatedDate(new Date());                                                                                                                                                                                                                                                                                                                   
		        		try{                                                                                                                                                                                                                                                                                                                                                
		        			SimpleDateFormat formatoFechayHora = new SimpleDateFormat("yyyyMMdd" + " " + "HHmmss");                                                                                                                                                                                                                                                     
		        			SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyyMMdd");                                                                                                                                                                                                                                                                           
		        			if (valoresBusqueda[i].getHoraPublicacion()!=null && !valoresBusqueda[i].getHoraPublicacion().equals("")){                                                                                                                                                                                                                                  
		        				Date fechayHoraPublicacion = formatoFechayHora.parse(valoresBusqueda[i].getFechaPublicacion() + " " + valoresBusqueda[i].getHoraPublicacion());                                                                                                                                                                                     
		        				entry.setPublishedDate(fechayHoraPublicacion);                                                                                                                                                                                                                                                                                      
		        				log("Fecha y hora de publicación del ODE cargada correctamente");                                                                                                                                                                                                                                                             
		        			}else{                                                                                                                                                                                                                                                                                                                                      
		        				Date fechaPublicacion = formatoFecha.parse(valoresBusqueda[i].getFechaPublicacion());                                                                                                                                                                                                                                               
		        				entry.setPublishedDate(fechaPublicacion);                                                                                                                                                                                                                                                                                           
		        				log("Fecha de publicación del ODE cargada correctamente");                                                                                                                                                                                                                                                                    
		        			}                                                                                                                                                                                                                                                                                                                                           
			        		                                                                                                                                                                                                                                                                                                                                            
			        		                                                                                                                                                                                                                                                                                                                                            
		        		}catch (Exception e){                                                                                                                                                                                                                                                                                                                               
		        			logger.error("Error al cargar la fecha o la hora del ODE", e);                                                                                                                                                                                                                                                                                 
		        		}                                                                                                                                                                                                                                                                                                                                                   
		        		                                                                                                                                                                                                                                                                                                                                                    
//		        		SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyyMMdd" + " " + "HHmmss");		        				        		                                                                                                                                                                                    
//		        		Date fechaPublicacion = formatoFecha.parse(valoresBusqueda[i].getFechaPublicacion() + " " + valoresBusqueda[i].getHoraPublicacion());                                                                                                                                                                                                               
//		        		entry.setPublishedDate(fechaPublicacion);                                                                                                                                                                                                                                                                                                           
		        		                                                                                                                                                                                                                                                                                                                                                    
		        		                                                                                                                                                                                                                                                                                                                                                    
		        		if (valoresBusqueda[i].getNodo()!=null){                                                                                                                                                                                                                                                                                                            
		        			image.setUrl(http + valoresBusqueda[i].getNodo() + "/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                      
			        		image.setLink(http + valoresBusqueda[i].getNodo());                                                                                                                                                                                                                                                                                         
		        		}else{                                                                                                                                                                                                                                                                                                                                              
		        			image.setUrl(http + feedHost + "/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                          
		        			image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                             
		        		}                                                                                                                                                                                                                                                                                                                                                   
		        		image.setTitle("");                                                                                                                                                                                                                                                                                                                                 
			                                                                                                                                                                                                                                                                                                                                                                    
		        		imagenItem = new SyndContentImpl();                                                                                                                                                                                                                                                                                                                 
		        		imagenItem.setType("html");                                                                                                                                                                                                                                                                                                                         
		        		imagenItem.setMode("escaped");                                                                                                                                                                                                                                                                                                                      
		        		if (valoresBusqueda[i].getUrlImagen()!=null && !valoresBusqueda[i].getUrlImagen().equals("")){                                                                                                                                                                                                                                                      
		        			if (valoresBusqueda[i].getNodo()!=null){                                                                                                                                                                                                                                                                                                    
		        				imagenItem.setValue("<p img class='centrado'><a href='" + http + valoresBusqueda[i].getNodo() + ampliarImagen(valoresBusqueda[i].getUrlImagen()) + "'target='_blank'><img src='" + http + valoresBusqueda[i].getNodo() + valoresBusqueda[i].getUrlImagen() + "'/></a></p>" + valoresBusqueda[i].getDescripcion());                  
		        			}else{                                                                                                                                                                                                                                                                                                                                      
		        				imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost + ampliarImagen(valoresBusqueda[i].getUrlImagen()) + "'target='_blank'><img src='" + http + feedHost + valoresBusqueda[i].getUrlImagen() + "'/></a></p>" + valoresBusqueda[i].getDescripcion());                                                          
		        			}                                                                                                                                                                                                                                                                                                                                           
		        		}else{                                                                                                                                                                                                                                                                                                                                              
		        			imagenItem.setValue("");                                                                                                                                                                                                                                                                                                                    
		        		}                                                                                                                                                                                                                                                                                                                                                   
			                                                                                                                                                                                                                                                                                                                                                                    
		        		List contenido = new ArrayList();                                                                                                                                                                                                                                                                                                                   
		        		contenido.add(imagenItem);                                                                                                                                                                                                                                                                                                                          
		        		entry.setContents(contenido);                                                                                                                                                                                                                                                                                                                       
			         			         			                                                                                                                                                                                                                                                                                                    
		        	} catch (Exception e){                                                                                                                                                                                                                                                                                                                                      
		        		log("No hemos podido recuperar los datos del ODE");                                                                                                                                                                                                                                                                                           
			            entry.setTitle("Item erróneo");                                                                                                                                                                                                                                                                                                                         
			            entry.setLink("");                                                                                                                                                                                                                                                                                                                                      
			            entry.setUpdatedDate(new Date());                                                                                                                                                                                                                                                                                                                       
			            entry.setPublishedDate(new Date());                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                            
			            image.setUrl(http + feedHost +"/static/img/logo_agrega_red.gif");                                                                                                                                                                                                                                                                                       
			            image.setLink(http + feedHost);                                                                                                                                                                                                                                                                                                                         
			            image.setTitle("");                                                                                                                                                                                                                                                                                                                                     
			                                                                                                                                                                                                                                                                                                                                                                    
			            imagenItem = new SyndContentImpl();                                                                                                                                                                                                                                                                                                                     
			            imagenItem.setType("html");                                                                                                                                                                                                                                                                                                                             
			            imagenItem.setMode("escaped");                                                                                                                                                                                                                                                                                                                          
			            imagenItem.setValue("<p img class='centrado'><a href='" + http + feedHost +"/galeriaimg/es_20080729_1_9173013/es_20080729_1_9173013.png' target='_blank'><img src='" + http + feedHost +"/galeriaimg/es_20080729_1_9173013/es_20080729_1_9173013.png'/></a></p>" + "No se han podido recuperar los datos necesarios para la formación de este item...");
			         		                                                                                                                                                                                                                                                                                                                                            
			            List contenido = new ArrayList();                                                                                                                                                                                                                                                                                                                       
			            contenido.add(imagenItem);                                                                                                                                                                                                                                                                                                                              
			            entry.setContents(contenido);                                                                                                                                                                                                                                                                                                                           
			                                                                                                                                                                                                                                                                                                                                                                    
		        	}                                                                                                                                                                                                                                                                                                                                                           
		        	   	                                                                                                                                                                                                                                                                                                                                                    
		            entries.add(entry);                                                                                                                                                                                                                                                                                                                                             
		        }                                                                                                                                                                                                                                                                                                                                                                   
		                                                                                                                                                                                                                                                                                                                                                                            
		        //Escribimos en el fichero                                                                                                                                                                                                                                                                                                                                          
		                                                                                                                                                                                                                                                                                                                                                                 
		        log("comenzamos a generar los ficheros...");                                                                                                                                                                                                                                                                                                                  
		        feed.setEntries(entries);                                                                                                                                                                                                                                                                                                                                           
		        feed.setImage(image);                                                                                                                                                                                                                                                                                                                                               
		        feed.setDescription(descripcion);                                                                                                                                                                                                                                                                                                                                   
		        //RSS                                                                                                                                                                                                                                                                                                                                                               
		    	feed.setTitle(traduceEtiqueta("resultadosBusqueda.title_rss",idiomaNavegacion));		    	                                                                                                                                                                                                                                                                    
	            feed.setFeedType(getPropertyValue("feedTypeRSS"));                                                                                                                                                                                                                                                                                                                      
		        log("SrvAgregadorRssServiceImpl - crearXMLBusqueda: generando: " + feedPathResultadosBusqueda + fileNameRss);                                                                                                                                                                                                                                                 
		                                                                                                                                                                                                                                                                                                                                                                            
//		        WireFeedOutput outputter = new WireFeedOutput();                                                                                                                                                                                                                                                                                                                    
//		        WireFeed wirefeed = feed.createWireFeed("myrss_2.0");                                                                                                                                                                                                                                                                                                               
//		        System.out.println(outputter.output(wirefeed));                                                                                                                                                                                                                                                                                                                     
		                                                                                                                                                                                                                                                                                                                                                                            
		                                                                                                                                                                                                                                                                                                                                                                            
//		        crear carpeta temp para no guardar con el resto de rss                                                                                                                                                                                                                                                                                                              
		        Writer writer = new FileWriter(feedPathResultadosBusqueda + fileNameRss);                                                                                                                                                                                                                                                                                           
		        SyndFeedOutput output = new SyndFeedOutput();                                                                                                                                                                                                                                                                                                                       
		        output.output(feed,writer);                                                                                                                                                                                                                                                                                                                                         
		        writer.close();                                                                                                                                                                                                                                                                                                                                                     
				log("SrvAgregadorRssServiceImpl - crearXMLBusqueda: generando correctamente feed RSS: " + titulo);                                                                                                                                                                                                                                                    
		                                                                                                                                                                                                                                                                                                                                                                            
	        } else {                                                                                                                                                                                                                                                                                                                                                                    
				logger.info("SrvAgregadorRssServiceImpl - crearXMLBusqueda: no hay datos para generar el feed ATOM: " + titulo);                                                                                                                                                                                                                                               
	        }                                                                                                                                                                                                                                                                                                                                                                           
        }catch (Exception e){                                                                                                                                                                                                                                                                                                                                                               
        	logger.error("[CREARXMLBusqueda] Se ha producido un error al crear el fichero: " + titulo + "--> ", e);                                                                                                                                                                                                                                                                        
        }                                                                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                            
    /**                                                                                                                                                                                                                                                                                                                                                                                     
	 * Este metodo recibe un VO del Agregador para mapear a uno del Buscar,                                                                                                                                                                                                                                                                                                             
	 * genera el titulo del fichero a eliminar y lo elimina                                                                                                                                                                                                                                                                                                                             
	 *                                                                                                                                                                                                                                                                                                                                                                                  
	 * @param ParametrosBusquedaAgregadorVO parametrosBusqueda: Parametro con los datos para realizar la busqueda.                                                                                                                                                                                                                                                                      
	 */                                                                                                                                                                                                                                                                                                                                                                                 
	protected void handleEliminarFichero(ParametrosBusquedaAgregadorVO param) throws Exception {                                                                                                                                                                                                                                                                                        
		                                                                                                                                                                                                                                                                                                                                                                            
		ParametrosBusquedaAvanzadaVO paramBusq = mapearParametrosBusqueda(param);                                                                                                                                                                                                                                                                                                   
		String tituloFichero ="";                                                                                                                                                                                                                                                                                                                                                   
		String tituloFicheroCodificado ="";                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                            
//		pongo nombre al fichero que voy a eliminar                                                                                                                                                                                                                                                                                                                                  
		try{                                                                                                                                                                                                                                                                                                                                                                        
			tituloFichero = this.getSrvBuscarService().generadorIdentificadorAvanzado(paramBusq);                                                                                                                                                                                                                                                                               
			tituloFicheroCodificado = codificarNombreFichero(tituloFichero);                                                                                                                                                                                                                                                                                                    
			log("SrvAgregadorRssServiceImpl - eliminarFichero: El identificador para el fichero xml a generar es " + tituloFicheroCodificado);                                                                                                                                                                                                                            
		}catch (Exception e){                                                                                                                                                                                                                                                                                                                                                       
			logger.error("SrvAgregadorRssServiceImpl - eliminarFichero: Error al generar el nombre de fichero con identificador unico",e);                                                                                                                                                                                                                                         
		}                                                                                                                                                                                                                                                                                                                                                                           
		                                                                                                                                                                                                                                                                                                                                                                            
		String rutaFichero=feedPathResultadosBusqueda+ tituloFicheroCodificado + "_rss.xml";                                                                                                                                                                                                                                                                                        
		File fichero = new File(rutaFichero);                                                                                                                                                                                                                                                                                                                                       
		                                                                                                                                                                                                                                                                                                                                                                            
//		elimino el fichero xml despues de guardar sus datos en el DataHandler		                                                                                                                                                                                                                                                                                            
		try{                                                                                                                                                                                                                                                                                                                                                                        
			if (fichero.exists()){                                                                                                                                                                                                                                                                                                                                              
				fichero.delete();                                                                                                                                                                                                                                                                                                                                           
				log("SrvAgregadorRssServiceImpl - eliminarFichero: Se ha eliminado correctamente el fichero xml");                                                                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                                                                                                                                   
			                                                                                                                                                                                                                                                                                                                                                                    
		}catch (Exception e){                                                                                                                                                                                                                                                                                                                                                       
			logger.error("SrvAgregadorRssServiceImpl - eliminarFichero: Se ha producido un error al eliminar el fichero xml");                                                                                                                                                                                                                                                     
		}
	}                                                                                                                                                                                                                                                                                                                                                                                   

	private ResourceBundle getBundleFile(String idioma)
	{
		ResourceBundle fichero = null;
		if ((fichero = (ResourceBundle)mapaIdiomas.get(idioma)) == null)  // si no existe, lo intentamos cargar
			fichero = addBundleFile(idioma);
		return fichero;
	}
	
	/*
	 * Añade un bundle para ese idioma a la coleccion de bundles y lo devuelve
	 * */
	private ResourceBundle addBundleFile(String idioma)
	{
		// Chequeamos que exista el fichero de bundle para el idioma dado.
		// Si no existe el fichero de properties para el idioma, no lo añadimos
		ResourceBundle fichero = null;
		try {
			fichero = ResourceBundle.getBundle("application-resources", new Locale(idioma));
		} catch (RuntimeException e) {
			// No existe un resource bundle para un idioma dado
			logger.warn("Excepcion intentando buscar el fichero de bundle para el idioma["+idioma+"]["+e.getCause()+"]");
			return null;
		}
		if (fichero == null)
			return fichero;
		
		mapaIdiomas.put(idioma, fichero);
		return fichero;
	}
	
	/**
	 * Este metodo traduce la etiqueta que le pasan al idioma que se le suministra
	 * @param etiqueta tag que se quiere traducir
	 * @param idioma codigo de idioma ISO-639 en el que se quiere obtener la traduccion
	 * @return
	 */
	public String traduceEtiqueta(String etiqueta, String idioma)
	{
		
		ResourceBundle fichero = getBundleFile(idioma);
		if (fichero != null)
			return fichero.getString(etiqueta);
		else
			return "";
	}
}                                                                                                                                                                                                                                                                                                                                                                                           